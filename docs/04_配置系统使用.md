# 04_é…ç½®ç³»ç»Ÿä½¿ç”¨

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£å®¹å™¨é…ç½®ç³»ç»Ÿ
- æŒæ¡è§’è‰²å’Œæƒé™é…ç½®
- å­¦ä¼šåˆ›å»ºè‡ªå®šä¹‰å®¹å™¨

## ğŸ“¦ å®¹å™¨é…ç½®ç³»ç»Ÿ

### æ ¸å¿ƒæ¦‚å¿µ

æ¡†æ¶ä½¿ç”¨å¢å¼ºå‹å·¥å…·å®¹å™¨ï¼ˆEnhancedToolContainerï¼‰æ¥ç®¡ç†å·¥å…·å’Œæƒé™ï¼š

```
å®¹å™¨ â†’ è§’è‰²é…ç½® â†’ å·¥å…·æ³¨å†Œ â†’ æƒé™è¿‡æ»¤
```

### é…ç½®æ¥å£

```typescript
interface ContainerConfig {
  name: string;           // å®¹å™¨åç§°
  description: string;    // å®¹å™¨æè¿°
  defaultRole: string;    // é»˜è®¤è§’è‰²
  roles: {                // è§’è‰²å®šä¹‰
    [roleName: string]: {
      name: string;       // è§’è‰²æ˜¾ç¤ºåç§°
      allowedGroups: string[] | ['*'];  // å…è®¸çš„ç»„
    }
  };
}
```

## ğŸ”§ åˆ›å»ºå®¹å™¨é…ç½®

### 1. åŸºç¡€å®¹å™¨é…ç½®

```typescript
// src/index.ts
const basicConfig: ContainerConfig = {
  name: 'åŸºç¡€å·¥å…·é›†',
  description: 'åŸºç¡€å·¥å…·ï¼Œæ‰€æœ‰ç”¨æˆ·å¯ç”¨',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'æ™®é€šç”¨æˆ·',
      allowedGroups: ['public', 'basic']
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'basic', 'advanced', 'sensitive', 'data-group']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};

// åˆ›å»ºå®¹å™¨
const basicToolSet = new EnhancedToolContainer(
  'åŸºç¡€å·¥å…·é›†',
  'basic',
  basicConfig
);
```

### 2. é«˜çº§å®¹å™¨é…ç½®

```typescript
const advancedConfig: ContainerConfig = {
  name: 'é«˜çº§å·¥å…·é›†',
  description: 'é«˜çº§åˆ†æå’Œå¤„ç†å·¥å…·',
  defaultRole: 'analyst',
  roles: {
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'advanced', 'sensitive', 'data-group']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};

const advancedToolSet = new EnhancedToolContainer(
  'é«˜çº§å·¥å…·é›†',
  'advanced',
  advancedConfig
);
```

### 3. æ‰©å±•å®¹å™¨é…ç½®

```typescript
const extendedConfig: ContainerConfig = {
  name: 'æ‰©å±•å·¥å…·é›†',
  description: 'ç‰¹æ®ŠåŠŸèƒ½å·¥å…·',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'æ™®é€šç”¨æˆ·',
      allowedGroups: ['public', 'file-io']
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'file-io', 'network']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};

const extendedToolSet = new EnhancedToolContainer(
  'æ‰©å±•å·¥å…·é›†',
  'extended',
  extendedConfig
);
```

## ğŸ› ï¸ å·¥å…·æ³¨å†Œ

### 1. æ³¨å†Œåˆ°åŸºç¡€å®¹å™¨

```typescript
// src/index.ts
import { echoTool } from './tools/echo.js';
import { addTool } from './tools/add.js';

function registerTools() {
  // æ³¨å†ŒåŸºç¡€å·¥å…·
  basicToolSet.register(echoTool);
  basicToolSet.register(addTool);
  
  // æ³¨å†ŒTokenç®¡ç†å·¥å…·
  tokenManagementTools.forEach(tool => {
    basicToolSet.register(tool);
  });
}
```

### 2. æ³¨å†Œåˆ°é«˜çº§å®¹å™¨

```typescript
import { demoTool } from './tools/demo-tool.js';
import { dataFilterTool } from './tools/data-filter.js';

function registerAdvancedTools() {
  // æ³¨å†Œæ¼”ç¤ºå·¥å…·
  advancedToolSet.register(demoTool);
  
  // æ³¨å†Œæ•°æ®å¤„ç†å·¥å…·
  advancedToolSet.register(dataFilterTool);
  advancedToolSet.register(dataSortTool);
  advancedToolSet.register(dataTransformTool);
  advancedToolSet.register(dataAggregateTool);
}
```

### 3. æ³¨å†Œåˆ°æ‰©å±•å®¹å™¨

```typescript
import { fileReadTool } from './tools/file-read.js';
import { fileWriteTool } from './tools/file-write.js';

function registerExtendedTools() {
  // æ³¨å†Œæ–‡ä»¶æ“ä½œå·¥å…·
  extendedToolSet.register(fileReadTool);
  extendedToolSet.register(fileWriteTool);
  extendedToolSet.register(fileSearchTool);
  extendedToolSet.register(fileClearCacheTool);
  
  // æ³¨å†Œç½‘ç»œå·¥å…·
  extendedToolSet.register(httpRequestTool);
}
```

## ğŸ” æƒé™é…ç½®ç­–ç•¥

### 1. æœ€å°æƒé™åŸåˆ™

```typescript
// âœ… å¥½ï¼šåªåˆ†é…å¿…è¦çš„ç»„
const minimalConfig: ContainerConfig = {
  name: 'æœ€å°æƒé™å®¹å™¨',
  description: 'ä»…åŒ…å«å¿…è¦çš„å…¬å…±å·¥å…·',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'æ™®é€šç”¨æˆ·',
      allowedGroups: ['public']  // åªå…è®¸å…¬å…±ç»„
    }
  }
};
```

### 2. åˆ†å±‚æƒé™

```typescript
// åˆ†å±‚æƒé™é…ç½®
const tieredConfig: ContainerConfig = {
  name: 'åˆ†å±‚æƒé™å®¹å™¨',
  description: 'æŒ‰å±‚çº§åˆ†é…æƒé™',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'ç”¨æˆ·',
      allowedGroups: ['public', 'basic']
    },
    'power-user': {
      name: 'é«˜çº§ç”¨æˆ·',
      allowedGroups: ['public', 'basic', 'advanced', 'file-io']
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'basic', 'advanced', 'sensitive', 'data-group', 'file-io', 'network']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};
```

### 3. åŠŸèƒ½éš”ç¦»

```typescript
// æŒ‰åŠŸèƒ½éš”ç¦»çš„å®¹å™¨
const fileConfig: ContainerConfig = {
  name: 'æ–‡ä»¶æ“ä½œå®¹å™¨',
  description: 'ä¸“é—¨çš„æ–‡ä»¶å¤„ç†å·¥å…·',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'ç”¨æˆ·',
      allowedGroups: ['public', 'file-io']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['public', 'file-io', 'admin-only']
    }
  }
};

const dataConfig: ContainerConfig = {
  name: 'æ•°æ®å¤„ç†å®¹å™¨',
  description: 'æ•°æ®åˆ†æå’Œå¤„ç†å·¥å…·',
  defaultRole: 'analyst',
  roles: {
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'data-group', 'sensitive']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};
```

## ğŸ“Š é…ç½®ç®¡ç†

### 1. æŸ¥çœ‹æƒé™æŠ¥å‘Š

```typescript
// è·å–å®¹å™¨æƒé™æŠ¥å‘Š
const report = basicToolSet.getPermissionReport('user');
console.log(report);

// è¾“å‡ºç¤ºä¾‹ï¼š
// å®¹å™¨: åŸºç¡€å·¥å…·é›† (basic)
// è§’è‰²: user - æ™®é€šç”¨æˆ·
// å…è®¸çš„ç»„: public, basic
// å¯è§å·¥å…· (2/2):
//   âœ“ echo [public, basic]
//   âœ“ add [public, basic]
```

### 2. æ£€æŸ¥å·¥å…·æƒé™

```typescript
// æ£€æŸ¥ç‰¹å®šå·¥å…·æ˜¯å¦å¯è®¿é—®
const canAccess = basicToolSet.canAccess('user', 'echo');
console.log(canAccess); // true

// è·å–è§’è‰²å¯è§çš„æ‰€æœ‰å·¥å…·
const visibleTools = basicToolSet.getToolsByRole('user');
console.log(visibleTools.map(t => t.name)); // ['echo', 'add']
```

### 3. åŠ¨æ€æ›´æ–°é…ç½®

```typescript
// åŠ¨æ€æ·»åŠ è§’è‰²
basicToolSet.roleConfig.roles['guest'] = {
  name: 'è®¿å®¢',
  allowedGroups: ['public']
};

// åŠ¨æ€æ›´æ–°è§’è‰²æƒé™
basicToolSet.roleConfig.roles['user'].allowedGroups.push('new-group');

// é‡æ–°éªŒè¯æƒé™
const newReport = basicToolSet.getPermissionReport('guest');
```

## ğŸ§ª é…ç½®æµ‹è¯•

### 1. æµ‹è¯•ä¸åŒè§’è‰²çš„æƒé™

```typescript
async function testContainerPermissions() {
  // æµ‹è¯•userè§’è‰²
  const userTools = basicToolSet.getToolsByRole('user');
  console.log('User tools:', userTools.map(t => t.name));
  
  // æµ‹è¯•analystè§’è‰²
  const analystTools = advancedToolSet.getToolsByRole('analyst');
  console.log('Analyst tools:', analystTools.map(t => t.name));
  
  // æµ‹è¯•adminè§’è‰²
  const adminTools = basicToolSet.getToolsByRole('admin');
  console.log('Admin tools:', adminTools.map(t => t.name));
  
  // æµ‹è¯•æƒé™æ£€æŸ¥
  console.log('Can user access demo_tool?', basicToolSet.canAccess('user', 'demo_tool')); // false
  console.log('Can analyst access demo_tool?', advancedToolSet.canAccess('analyst', 'demo_tool')); // true
}
```

### 2. é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•ä¸åŒè§’è‰²çš„å·¥å…·åˆ—è¡¨
# é»˜è®¤è§’è‰² (user)
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | node build/index.js

# åˆ‡æ¢åˆ°analystè§’è‰²
echo '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"switch_role","arguments":{"role":"analyst"}}}' | node build/index.js

# æŸ¥çœ‹å·¥å…·åˆ—è¡¨
echo '{"jsonrpc":"2.0","id":3,"method":"tools/list","params":{}}' | node build/index.js

# åˆ‡æ¢åˆ°adminè§’è‰²
echo '{"jsonrpc":"2.0","id":4,"method":"tools/call","params":{"name":"switch_role","arguments":{"role":"admin"}}}' | node build/index.js

# æŸ¥çœ‹æ‰€æœ‰å·¥å…·
echo '{"jsonrpc":"2.0","id":5,"method":"tools/list","params":{}}' | node build/index.js
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é…ç½®åŸåˆ™

```typescript
// âœ… å¥½ï¼šæ¸…æ™°çš„å‘½åå’Œæè¿°
const productionConfig: ContainerConfig = {
  name: 'ç”Ÿäº§ç¯å¢ƒå·¥å…·é›†',
  description: 'ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„å®‰å…¨å·¥å…·',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'æ™®é€šç”¨æˆ·',
      allowedGroups: ['public', 'basic']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};

// âŒ åï¼šæ¨¡ç³Šçš„é…ç½®
const badConfig: ContainerConfig = {
  name: 'å·¥å…·é›†',
  description: 'å„ç§å·¥å…·',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'ç”¨æˆ·',
      allowedGroups: ['public', 'basic', 'advanced', 'sensitive']  // æƒé™è¿‡å¤§
    }
  }
};
```

### 2. å®‰å…¨è€ƒè™‘

```typescript
// âœ… å¥½ï¼šæœ€å°æƒé™ + åˆ†å±‚ç®¡ç†
const secureConfig: ContainerConfig = {
  name: 'å®‰å…¨å®¹å™¨',
  description: 'ä¸¥æ ¼æ§åˆ¶çš„å·¥å…·å®¹å™¨',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'ç”¨æˆ·',
      allowedGroups: ['public']  // åªå…è®¸å…¬å…±å·¥å…·
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'basic', 'data-group']  // æŒ‰éœ€æˆæƒ
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']  // ç®¡ç†å‘˜éœ€è¦å®Œæ•´æƒé™
    }
  }
};
```

### 3. æ‰©å±•æ€§è€ƒè™‘

```typescript
// âœ… å¥½ï¼šæ˜“äºæ‰©å±•çš„é…ç½®
const extensibleConfig: ContainerConfig = {
  name: 'å¯æ‰©å±•å®¹å™¨',
  description: 'æ”¯æŒæœªæ¥æ‰©å±•çš„å®¹å™¨',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'ç”¨æˆ·',
      allowedGroups: ['public', 'basic']
    },
    // é¢„ç•™æ‰©å±•è§’è‰²
    'power-user': {
      name: 'é«˜çº§ç”¨æˆ·',
      allowedGroups: ['public', 'basic', 'advanced']
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'basic', 'advanced', 'data-group']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å·¥å…·å¼€å‘**ï¼š[01_å·¥å…·å¼€å‘åŸºç¡€.md](01_å·¥å…·å¼€å‘åŸºç¡€.md)
- **æƒé™æ§åˆ¶**ï¼š[02_æƒé™æ§åˆ¶è¯¦è§£.md](02_æƒé™æ§åˆ¶è¯¦è§£.md)
- **æ’ä»¶å¼€å‘**ï¼š[06_æ’ä»¶å¼€å‘æŒ‡å—.md](06_æ’ä»¶å¼€å‘æŒ‡å—.md)

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [06_æ’ä»¶å¼€å‘æŒ‡å—.md](06_æ’ä»¶å¼€å‘æŒ‡å—.md)