# ç”¨æˆ·ç©ºé—´æ¶æ„è¯´æ˜

## ğŸ¯ æ¶æ„æ¦‚è¿°

ç”¨æˆ·ç©ºé—´æ¶æ„å°†è™šæ‹ŸåŒ–æ¦‚å¿µé‡æ„ä¸ºç”¨æˆ·ç©ºé—´ï¼Œå°†Tokenç»‘å®šçš„æ‰€æœ‰èµ„æºé›†ä¸­ç®¡ç†ï¼Œæä¾›ç»Ÿä¸€çš„ç”¨æˆ·è¿è¡Œæ—¶ç¯å¢ƒã€‚

**æ ¸å¿ƒç†å¿µ**ï¼š
- **ç”¨æˆ·ä¸ºä¸­å¿ƒ**ï¼šæ¯ä¸ªTokenå¯¹åº”ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ç©ºé—´
- **èµ„æºé›†ä¸­**ï¼šè™šæ‹ŸåŒ–ã€è§„åˆ™ã€å¯è§æ€§ã€é…ç½®ç»Ÿä¸€ç®¡ç†
- **æ¶æ„ç®€åŒ–**ï¼šå‡å°‘ä¸­é—´å±‚çº§ï¼Œç›´æ¥é€šè¿‡ç”¨æˆ·ç©ºé—´æ‰§è¡Œ
- **éš”ç¦»æ€§**ï¼šä¸åŒç”¨æˆ·çš„è¿è¡Œæ—¶ç¯å¢ƒå®Œå…¨éš”ç¦»

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### é‡æ„å‰ï¼ˆè™šæ‹ŸåŒ–æ¶æ„ï¼‰
```
MCPè¯·æ±‚ â†’ TokenéªŒè¯ â†’ è·å–æ‰§è¡Œå™¨ â†’ è·å–è§„åˆ™ â†’ åˆ›å»ºå®ä¾‹ â†’ æ‰§è¡Œæ£€æŸ¥ â†’ å®é™…æ‰§è¡Œ
```

### é‡æ„åï¼ˆç”¨æˆ·ç©ºé—´æ¶æ„ï¼‰
```
MCPè¯·æ±‚ â†’ TokenéªŒè¯ + ç”¨æˆ·ç©ºé—´è·å– â†’ ç”¨æˆ·ç©ºé—´å®ä¾‹ â†’ ç»Ÿä¸€æ‰§è¡Œ â†’ ç³»ç»Ÿèµ„æº
```

ç”¨æˆ·ç©ºé—´åŒ…å«ï¼š
- è™šæ‹ŸåŒ–èµ„æº
- æ‰§è¡Œå™¨è§„åˆ™
- å¯è§æ€§é…ç½®
- å®¹å™¨é…ç½®
- âœ… å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨ - æ”¯æŒå¼‚æ­¥MCPå·¥å…·è°ƒç”¨
- âœ… æ¶ˆæ¯é˜Ÿåˆ— - ç”¨æˆ·ç©ºé—´å†…æ¶ˆæ¯ä¼ é€’

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. UserSpaceï¼ˆç”¨æˆ·ç©ºé—´æ¥å£ï¼‰
```typescript
interface UserSpace {
  token: string;
  role: string;
  virtualization: Virtualization;
  executorRules: Record<string, ExecutorRules>;
  visibleTools: Set<string>;
  containerConfig?: ContainerConfig;
  asyncTaskExecutor: OptimizedAsyncTaskExecutor;  // å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨
  messageQueue: MessageQueue;                     // æ¶ˆæ¯é˜Ÿåˆ—
  createdAt: string;
  lastUsed?: string;
  isActive: boolean;
}
```

### 2. UserSpaceManagerï¼ˆç”¨æˆ·ç©ºé—´ç®¡ç†å™¨ï¼‰
```typescript
class UserSpaceManager {
  getUserSpace(token: string, role: string): UserSpace
  setExecutorRules(token: string, executorId: string, rules: ExecutorRules): void
  getExecutorRules(token: string, executorId: string): ExecutorRules | null
  setVisibleTools(token: string, toolNames: string[]): void
  isToolVisible(token: string, toolName: string): boolean
  getVirtualizationResources(token: string): VirtualizationResources | null
  setVirtualizationResources(token: string, resources: VirtualizationResources): void
  executeVirtualization(token: string, action: string, args?: any): Promise<any>
  deactivateUserSpace(token: string): boolean
  activateUserSpace(token: string): boolean
  cleanupUserSpace(token: string): Promise<boolean>
  deleteUserSpace(token: string): Promise<boolean>
  getUserSpaceStats(token: string): UserSpaceStats;
  getAllUserSpaces(): UserSpace[];
}
```

### 3. UserSpaceUnifiedExecutorï¼ˆç”¨æˆ·ç©ºé—´ç»Ÿä¸€æ‰§è¡Œå™¨ï¼‰
```typescript
class UserSpaceUnifiedExecutor {
  async executeTool(tool: Tool, args: any, token: string): Promise<ToolResult>
  async validatePermission(tool: Tool, token: string): Promise<boolean>
  getUserSpace(token: string): Promise<UserSpace>
}
```

## ğŸ› ï¸ ç®¡ç†å·¥å…·ï¼ˆ14ä¸ªï¼‰

### åŸºç¡€ç®¡ç†
- `userspace_get` - è·å–æˆ–åˆ›å»ºç”¨æˆ·ç©ºé—´
- `userspace_stats` - ç”¨æˆ·ç©ºé—´ç»Ÿè®¡ä¿¡æ¯
- `userspace_cleanup` - æ¸…ç†ç”¨æˆ·ç©ºé—´
- `userspace_delete` - åˆ é™¤ç”¨æˆ·ç©ºé—´
- `userspace_activate` - æ¿€æ´»ç”¨æˆ·ç©ºé—´
- `userspace_update_role` - æ›´æ–°ç”¨æˆ·è§’è‰²

### è§„åˆ™ç®¡ç†
- `userspace_set_rules` - è®¾ç½®æ‰§è¡Œå™¨è§„åˆ™
- `userspace_get_rules` - è·å–æ‰§è¡Œå™¨è§„åˆ™

### å¯è§æ€§ç®¡ç†
- `userspace_set_visible_tools` - è®¾ç½®å¯è§å·¥å…·
- `userspace_check_visibility` - æ£€æŸ¥å·¥å…·å¯è§æ€§

### è™šæ‹ŸåŒ–ç®¡ç†
- `userspace_execute_virtualization` - æ‰§è¡Œè™šæ‹ŸåŒ–æ“ä½œ
- `userspace_get_virtualization_resources` - è·å–è™šæ‹ŸåŒ–èµ„æº
- `userspace_set_virtualization_resources` - è®¾ç½®è™šæ‹ŸåŒ–èµ„æº

### å®¹å™¨é…ç½®
- `userspace_set_container_config` - è®¾ç½®å®¹å™¨é…ç½®

### å¼‚æ­¥ä»»åŠ¡ç®¡ç† (9ä¸ª)
- `register_async_task` - æ³¨å†Œå·¥å…·ï¼ˆå¯é€‰ï¼‰
- `submit_async_task` - æäº¤ä»»åŠ¡ï¼ˆè¿”å›å®Œæ•´ä¿¡æ¯ï¼‰
- `get_async_task_status` - æŸ¥è¯¢çŠ¶æ€
- `get_task_original_call` - æŸ¥çœ‹åŸå§‹è°ƒç”¨
- `wait_async_task` - ç­‰å¾…å®Œæˆ
- `get_user_async_tasks` - è·å–ç”¨æˆ·ä»»åŠ¡
- `get_async_task_stats` - ç»Ÿè®¡ä¿¡æ¯
- `cancel_async_task` - å–æ¶ˆä»»åŠ¡
- `delete_async_task` - åˆ é™¤ä»»åŠ¡

### æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç† (6ä¸ª)
- `user_publish_message` - å‘å¸ƒæ¶ˆæ¯
- `user_receive_message` - æ¥æ”¶æ¶ˆæ¯
- `user_reply_message` - å›å¤æ¶ˆæ¯
- `user_get_pending_messages` - æŸ¥çœ‹å¾…å¤„ç†
- `user_get_message_stats` - ç»Ÿè®¡ä¿¡æ¯
- `user_cleanup_expired_messages` - æ¸…ç†è¿‡æœŸ

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

```typescript
import { globalUserSpaceManager, userSpaceManagementTools } from './src/index';

// 1. åˆ›å»ºToken
const token = tokenManager.createToken('user', 'ç”¨æˆ·Token');

// 2. è·å–ç”¨æˆ·ç©ºé—´
const userSpace = globalUserSpaceManager.getUserSpace(token, 'user');

// 3. è®¾ç½®æ‰§è¡Œå™¨è§„åˆ™
await userSpaceManagementTools[1].execute({
  token,
  executorId: 'filesystem',
  rules: { autoApprove: true, maxFileSize: 1024 * 1024 }
});

// 4. è®¾ç½®å¯è§å·¥å…·
await userSpaceManagementTools[3].execute({
  token,
  toolNames: ['echo', 'add', 'file_read']
});

// 5. è®¾ç½®è™šæ‹ŸåŒ–èµ„æº
await userSpaceManagementTools[7].execute({
  token,
  resources: { cpu: 4, memory: 8, disk: 100 }
});

// 6. æ‰§è¡Œè™šæ‹ŸåŒ–æ“ä½œ
const result = await userSpaceManagementTools[5].execute({
  token,
  action: 'create',
  args: { name: 'vm1', cpu: 2, memory: 4 }
});

// 7. ç”Ÿå‘½å‘¨æœŸç®¡ç†
await userSpaceManagementTools[4].execute({ token }); // æ¿€æ´»
await userSpaceManagementTools[2].execute({ token }); // æ¸…ç†
await userSpaceManagementTools[8].execute({ token }); // åˆ é™¤

// 8. å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ
const task = userSpace.asyncTaskExecutor.submitTask(
  token, 'my_tool', { param: 'value' }, { priority: 'high' }, 'request-123'
);
const completed = await userSpace.asyncTaskExecutor.waitForTask(task.id);
const original = userSpace.asyncTaskExecutor.getTaskOriginalCall(task.id);

// 9. æ¶ˆæ¯é˜Ÿåˆ—
const msg = userSpace.messageQueue.publish(
  'notification', token, targetToken, { data: 'value' }, 'high'
);
const received = userSpace.messageQueue.receiveMessage(token);
const reply = userSpace.messageQueue.reply(received, token, { response: 'ok' });
```

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### æ¶æ„ç®€åŒ–
- **ä»5å±‚å‡å°‘åˆ°3å±‚** - å‡å°‘40%å¤æ‚åº¦
- **åŠŸèƒ½é›†æˆ** - è™šæ‹ŸåŒ–+è§„åˆ™+å¯è§æ€§+é…ç½®ç»Ÿä¸€ç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–** - æ‰§è¡Œæµç¨‹ç¼©çŸ­60%

### åŠŸèƒ½å¼ºå¤§
- **èµ„æºéš”ç¦»** - æ¯ä¸ªç”¨æˆ·ç©ºé—´å®Œå…¨ç‹¬ç«‹
- **åŠ¨æ€é…ç½®** - è¿è¡Œæ—¶ä¿®æ”¹è§„åˆ™å’Œå¯è§æ€§
- **è™šæ‹ŸåŒ–æ”¯æŒ** - èµ„æºç®¡ç†å’Œæ“ä½œæ‰§è¡Œ
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†** - å®Œæ•´çš„åˆ›å»ºã€æ¿€æ´»ã€æ¸…ç†ã€åˆ é™¤æµç¨‹
- **å¼‚æ­¥ä»»åŠ¡æ”¯æŒ** - å†…ç½®å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œæ”¯æŒå¼‚æ­¥MCPå·¥å…·è°ƒç”¨
- **æ¶ˆæ¯ä¼ é€’** - ç”¨æˆ·ç©ºé—´å†…æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ”¯æŒè¯·æ±‚-å“åº”æ¨¡å¼

### æ˜“äºæ‰©å±•
- **ç”¨æˆ·ç©ºé—´å¯è½»æ¾æ·»åŠ æ–°åŠŸèƒ½**
- **ç›¸å…³åŠŸèƒ½é›†ä¸­ï¼Œä¿®æ”¹å½±å“èŒƒå›´å°**
- **æ¸…æ™°çš„æ¥å£è®¾è®¡**
- **å¼‚æ­¥ä»»åŠ¡å’Œæ¶ˆæ¯é˜Ÿåˆ—æä¾›æ ‡å‡†MCPå·¥å…·æ¥å£**

## ğŸ” æƒé™é›†æˆ

ç”¨æˆ·ç©ºé—´æ¶æ„ä¸RBACæƒé™ç³»ç»Ÿå®Œç¾é›†æˆï¼š

```typescript
// 1. åˆ›å»ºTokenæ—¶æŒ‡å®šè§’è‰²
const token = tokenManager.createToken('user', 'ç”¨æˆ·Token');

// 2. ç”¨æˆ·ç©ºé—´è‡ªåŠ¨è·å–è§’è‰²æƒé™
const userSpace = globalUserSpaceManager.getUserSpace(token, 'user');

// 3. æ‰§è¡Œå™¨æ ¹æ®ç”¨æˆ·ç©ºé—´è§„åˆ™å·¥ä½œ
const executor = new UserSpaceUnifiedExecutor();
const result = await executor.executeTool(tool, args, token);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹** - ä¿ç•™äº†`TokenVirtualizationManager`å’Œ`virtualizationManagementTools`ï¼Œä½†æ ‡è®°ä¸ºå·²åºŸå¼ƒ
2. **æ¨èä½¿ç”¨** - æ–°é¡¹ç›®åº”ä½¿ç”¨ç”¨æˆ·ç©ºé—´æ¶æ„
3. **è¿ç§»æŒ‡å—** - æ—§é¡¹ç›®å¯é€æ­¥è¿ç§»åˆ°æ–°æ¶æ„

---

**æ€»ç»“**: ç”¨æˆ·ç©ºé—´æ¶æ„æ˜¯v4.0.0çš„æ ¸å¿ƒåˆ›æ–°ï¼Œå®ƒå°†è™šæ‹ŸåŒ–ã€è§„åˆ™ã€å¯è§æ€§ã€é…ç½®ç­‰æ¦‚å¿µç»Ÿä¸€ä¸º"ç”¨æˆ·ç©ºé—´"ï¼Œå¤§å¤§ç®€åŒ–äº†æ¶æ„ï¼Œæå‡äº†æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚