# 11_组织架构管理

## 一、概述

组织架构管理模块提供了基于协作组件的团队协作能力，通过代理执行机制实现多用户间的权限共享和工具协作。该模块是v4.0.0版本的核心新增功能。

### 核心概念

**协作组件 (Collaboration Component)**: 
- 通过组合用户空间实现职权
- 作为代理中间件，管理成员权限
- 自动为工具添加组件前缀，避免命名冲突

**组织成员 (Organization Member)**:
- 基于用户空间的成员身份
- 可同时加入多个协作组件
- 拥有角色区分（admin/member）

**代理执行 (Proxy Execution)**:
- 协作组件作为中间件代理工具调用
- 自动赋予权限并验证成员资格
- 支持跨组件工具调用

## 二、架构设计

### 2.1 核心组件

```
GlobalOrganizationManager (全局管理器)
├── CollaborationComponent (协作组件)
│   ├── StandardCollaborationComponent (标准实现)
│   └── CustomComponent (自定义实现)
├── OrganizationMember (组织成员)
└── ToolPrefixManager (前缀管理器)
```

### 2.2 权限模型

```
用户Token → 组织成员 → 协作组件 → 代理执行
                    ↓
              角色管理 (admin/member)
                    ↓
              工具过滤 (groups)
```

## 三、核心类详解

### 3.1 GlobalOrganizationManager

**职责**: 全局管理所有协作组件和成员

**核心方法**:
```typescript
// 注册协作组件
async registerCollaborationComponent(
  config: CollaborationComponentConfig,
  componentFactory?: (config) => CollaborationComponent
): Promise<CollaborationComponent>

// 创建组织成员
createMember(
  name: string,
  userToken: string,
  role: 'admin' | 'member' = 'member'
): Promise<OrganizationMember>

// 将成员添加到组件
addMemberToComponent(
  memberId: string,
  componentId: string
): Promise<boolean>

// 获取成员的协作工具
getAllCollaborationTools(memberToken: string): Promise<Tool[]>

// 执行协作工具
executeCollaborationTool(
  memberToken: string,
  fullToolName: string,
  args: any
): Promise<ToolResult>
```

**配置选项**:
```typescript
interface GlobalOrganizationManagerConfig {
  tokenManager: TokenManager;        // Token管理器实例
  maxCollaborationUnits?: number;    // 最大组件数 (默认100)
  maxMembersPerUnit?: number;        // 每组件最大成员数 (默认1000)
  enableEvents?: boolean;            // 启用事件 (默认true)
  auditLevel?: 'none' | 'basic' | 'detailed' | 'full'; // 审计级别
}
```

### 3.2 StandardCollaborationComponent

**职责**: 标准协作组件实现，提供代理执行能力

**核心特性**:
- **组合模式**: 组合UserSpace实现权限继承
- **前缀管理**: 自动为工具添加`{componentId}_`前缀
- **角色验证**: 根据成员角色过滤工具
- **事件系统**: 支持事件监听和审计

**核心方法**:
```typescript
// 代理执行（核心）
async proxyExecute(
  memberToken: string,
  toolName: string,
  args: any,
  context: ProxyExecutionContext
): Promise<ProxyExecutionResult>

// 获取带前缀的MCP工具
async getMCPToolsWithPrefix(memberToken: string): Promise<Tool[]>

// 执行MCP工具
async executeMCPTool(
  memberToken: string,
  toolName: string,
  args: any
): Promise<ToolResult>

// 成员管理
addMember(member: OrganizationMember): boolean
removeMember(memberId: string): boolean
```

### 3.3 OrganizationMember

**成员结构**:
```typescript
interface OrganizationMember {
  id: string;
  name: string;
  userToken: string;           // 用户原始Token
  userSpace: UserSpace;        // 继承的用户空间
  collaborationComponents: Set<string>;  // 所在组件列表
  role: 'admin' | 'member';    // 角色
  status: 'active' | 'inactive' | 'suspended';
  joinedAt: string;
  lastActive?: string;
}
```

## 四、MCP API 集成

### 4.1 组织插件 (OrganizationPlugin)

组织插件提供全局的组织管理工具：

#### 基础工具（所有成员）
- `org_get_my_info` - 获取当前用户信息
- `org_list_my_components` - 列出用户所在组件
- `org_get_global_stats` - 获取组织统计

#### 管理员工具（仅admin）
- `admin_create_component` - 创建协作组件
- `admin_delete_component` - 删除组件
- `admin_create_member` - 创建成员
- `admin_add_member_to_component` - 分配成员到组件

#### 动态组件工具
- `{componentId}_proxy_execute` - 代理执行
- `{componentId}_list_members` - 列出成员
- `{componentId}_get_component_info` - 获取组件信息

### 4.2 标准协作组件工具

每个协作组件提供以下MCP工具：

#### 基础工具（所有成员）
```typescript
// 代理执行工具
proxy_execute: {
  toolName: string,
  args: object
}

// 成员管理
list_members: {}  // 列出所有成员
get_component_info: {}  // 获取组件信息
```

#### 管理员工具
```typescript
// 添加成员
add_member: {
  memberId: string
}

// 移除成员
remove_member: {
  memberId: string
}

// 设置激活状态
set_component_active: {
  active: boolean
}
```

### 4.3 全局工具提供器

为AI Agent提供统一的工具访问接口：

```typescript
// 获取所有协作工具（带前缀）
getAllCollaborationTools(memberToken: string): Promise<Tool[]>

// 执行协作工具
executeCollaborationTool(
  memberToken: string,
  fullToolName: string,  // 格式: componentId_toolName
  args: any
): Promise<ToolResult>

// 获取组件信息
getCollaborationComponentsInfo(memberToken: string): Promise<{
  components: Array<{
    id: string;
    name: string;
    tools: Array<{ name: string; description: string }>;
  }>;
  totalCount: number;
}>
```

## 五、工具前缀管理

### 5.1 前缀格式

**规则**: `{componentId}_{toolName}`

**示例**:
- `dev-team_proxy_execute`
- `data-team_list_members`
- `admin-group_add_member`

### 5.2 前缀管理器

```typescript
class ToolPrefixManager {
  // 添加前缀
  static addPrefix(componentId: string, toolName: string): string
  
  // 解析前缀
  static parsePrefix(fullName: string): {
    componentId: string;
    toolName: string;
  } | null
  
  // 验证格式
  static validateFormat(fullName: string): boolean
}
```

### 5.3 前缀解决的问题

1. **命名冲突**: 不同组件的同名工具不会冲突
2. **权限区分**: 通过前缀知道工具所属组件
3. **执行路由**: 根据前缀路由到正确组件
4. **AI理解**: AI能明确知道工具来源

## 六、使用流程

### 6.1 创建组织结构

```typescript
import { globalOrganizationManager } from './src/index';

// 1. 创建协作组件
const devTeam = await globalOrganizationManager.registerCollaborationComponent({
  id: 'dev-team',
  name: '开发团队',
  description: '负责代码开发和审查'
});

// 2. 创建组织成员
const alice = await globalOrganizationManager.createMember(
  'Alice',
  'user-token-alice',
  'admin'
);

const bob = await globalOrganizationManager.createMember(
  'Bob',
  'user-token-bob',
  'member'
);

// 3. 将成员添加到组件
await globalOrganizationManager.addMemberToComponent(alice.id, 'dev-team');
await globalOrganizationManager.addMemberToComponent(bob.id, 'dev-team');
```

### 6.2 获取和执行工具

```typescript
// 1. 获取成员的所有协作工具
const tools = await globalOrganizationManager.getAllCollaborationTools('user-token-alice');
// 返回: ['dev-team_proxy_execute', 'dev-team_list_members', ...]

// 2. 执行协作工具
const result = await globalOrganizationManager.executeCollaborationTool(
  'user-token-alice',
  'dev-team_proxy_execute',
  {
    toolName: 'file_read',
    args: { path: '/project/code.ts' }
  }
);
```

### 6.3 在AI Agent中使用

```typescript
import { createAdvancedQuickAgent } from './src/index';

// 创建高级Agent
const agent = createAdvancedQuickAgent('开发助手', {
  token: 'user-token-alice'
});

// Agent会自动获取所有协作工具
// 可以调用: dev-team_proxy_execute, data-team_list_members 等
await agent.execute({
  id: 'task-1',
  input: '使用dev-team的权限读取代码文件'
});
```

## 七、权限控制

### 7.1 基础权限（所有成员）

✅ 查看自己的信息
✅ 查看自己所在的组件
✅ 查看组织统计
✅ 查看组件内成员
✅ 获取组件信息
✅ 使用组件代理执行工具

### 7.2 组件权限（成员资格）

✅ 代理执行组件内工具
❌ 管理组件成员（需要admin）

### 7.3 管理权限（管理员）

✅ 创建/删除组件
✅ 创建成员
✅ 分配成员到组件
✅ 在组件内添加/移除成员
✅ 控制组件激活状态

### 7.4 权限验证点

1. **MCP服务器入口**: 统一权限管理器验证
2. **插件getTools()**: 根据token过滤可见工具
3. **插件execute()**: 验证工具执行权限
4. **协作组件**: 验证成员资格和角色

## 八、事件系统

### 8.1 事件类型

```typescript
enum OrganizationEventType {
  // 成员事件
  MEMBER_CREATED = 'member_created',
  MEMBER_JOINED = 'member_joined',
  MEMBER_LEFT = 'member_left',
  MEMBER_SUSPENDED = 'member_suspended',
  
  // 协作单元事件
  COLLABORATION_UNIT_CREATED = 'collaboration_unit_created',
  COLLABORATION_UNIT_UPDATED = 'collaboration_unit_updated',
  COLLABORATION_UNIT_DELETED = 'collaboration_unit_deleted',
  
  // 代理执行事件
  PROXY_EXECUTION = 'proxy_execution',
  PROXY_EXECUTION_FAILED = 'proxy_execution_failed',
}
```

### 8.2 事件监听

```typescript
// 全局事件
globalOrganizationManager.onEvent((event) => {
  console.log('组织事件:', event.type, event.data);
});

// 组件事件
component.onEvent((event) => {
  console.log('组件事件:', event.type, event.data);
});
```

### 8.3 审计日志

根据配置的`auditLevel`记录：
- `none`: 不记录
- `basic`: 记录关键操作
- `detailed`: 记录详细信息
- `full`: 记录所有细节

## 九、最佳实践

### 9.1 组件设计原则

1. **职责明确**: 每个组件代表一个明确的职责范围
2. **成员精简**: 控制每个组件的成员数量
3. **角色清晰**: 合理使用admin/member角色
4. **工具隔离**: 通过组件隔离不同的工具集

### 9.2 成员管理

```typescript
// 推荐：按项目创建组件
const projectA = await registerCollaborationComponent({
  id: 'project-a',
  name: '项目A团队'
});

// 推荐：按角色分配成员
await addMemberToComponent(alice.id, 'project-a'); // admin
await addMemberToComponent(bob.id, 'project-a');   // member

// 推荐：定期清理不活跃成员
const stats = await component.getStats();
if (stats.memberCount > 50) {
  // 考虑拆分组件
}
```

### 9.3 工具使用

```typescript
// 推荐：使用代理执行
const result = await executeCollaborationTool(
  token,
  'dev-team_proxy_execute',
  { toolName: 'file_read', args: { path } }
);

// 避免：直接调用组件内部工具
// ❌ component.executeMCPTool(token, 'file_read', args)
```

### 9.4 错误处理

```typescript
try {
  const result = await executeCollaborationTool(token, toolName, args);
  if (!result.success) {
    console.error('执行失败:', result.error);
  }
} catch (error) {
  if (error.message.includes('成员不存在')) {
    // 处理Token无效
  } else if (error.message.includes('未加入')) {
    // 处理权限不足
  }
}
```

## 十、性能优化

### 10.1 缓存策略

```typescript
// 组件信息缓存
const componentCache = new Map<string, CollaborationComponent>();

// 成员映射缓存
const memberCache = new Map<string, Set<string>>();
```

### 10.2 批量操作

```typescript
// 批量添加成员
const members = ['alice', 'bob', 'charlie'];
await Promise.all(
  members.map(id => 
    globalOrganizationManager.addMemberToComponent(id, 'team-a')
  )
);
```

### 10.3 异步清理

```typescript
// 定期清理过期组件
async function cleanupInactiveComponents() {
  const components = globalOrganizationManager.getAllComponents();
  for (const component of components) {
    const stats = component.getStats();
    if (stats.memberCount === 0) {
      await component.cleanup();
      globalOrganizationManager.deleteComponent(component.id);
    }
  }
}
```

## 十一、集成示例

### 11.1 完整工作流

```typescript
import { 
  globalOrganizationManager,
  createAdvancedQuickAgent 
} from './src/index';

// 1. 初始化组织
async function initializeOrganization() {
  // 创建组件
  const devTeam = await globalOrganizationManager.registerCollaborationComponent({
    id: 'dev-team',
    name: '开发团队',
    description: '代码开发和审查'
  });

  // 创建成员
  const alice = await globalOrganizationManager.createMember('Alice', 'token-alice', 'admin');
  const bob = await globalOrganizationManager.createMember('Bob', 'token-bob', 'member');

  // 分配成员
  await globalOrganizationManager.addMemberToComponent(alice.id, 'dev-team');
  await globalOrganizationManager.addMemberToComponent(bob.id, 'dev-team');

  return { devTeam, alice, bob };
}

// 2. 创建Agent
function createTeamAgent(memberToken: string) {
  return createAdvancedQuickAgent('团队助手', {
    token: memberToken
  });
}

// 3. 使用Agent
async function useTeamAgent() {
  const { alice } = await initializeOrganization();
  const agent = createTeamAgent(alice.userToken);

  // Agent可以访问dev-team的所有工具
  await agent.execute({
    id: 'task-1',
    input: '使用开发团队的权限读取代码文件'
  });
}
```

### 11.2 MCP服务器集成

```typescript
import { Server } from '@modelcontextprotocol/sdk/server';
import { globalOrganizationManager } from './src/index';

const server = new Server({
  name: 'organization-server',
  version: '1.0.0'
});

// 工具列表
server.setRequestHandler('tools/list', async (request) => {
  const token = request.params._meta?.token;
  
  if (!token) {
    return { tools: [] };
  }

  // 获取所有协作工具
  const tools = await globalOrganizationManager.getAllCollaborationTools(token);
  
  return { tools };
});

// 工具执行
server.setRequestHandler('tools/call', async (request) => {
  const token = request.params._meta?.token;
  const { name, arguments: args } = request.params;

  if (!token) {
    return { content: [{ type: 'text', text: '错误: Token缺失' }], isError: true };
  }

  return await globalOrganizationManager.executeCollaborationTool(token, name, args);
});
```

## 十二、故障排除

### 12.1 常见问题

**问题**: 成员无法访问组件工具
- **检查**: 成员是否已添加到组件
- **检查**: 组件是否激活
- **检查**: Token是否有效

**问题**: 工具执行失败
- **检查**: 工具名称格式是否正确（componentId_toolName）
- **检查**: 成员角色是否有权限
- **检查**: 组件的可见工具列表

**问题**: 前缀解析错误
- **检查**: 工具名是否包含下划线
- **检查**: 组件ID是否存在

### 12.2 调试技巧

```typescript
// 查看成员信息
const member = globalOrganizationManager.findMemberByToken(token);
console.log('成员:', member);
console.log('所在组件:', member.collaborationComponents);

// 查看组件信息
const component = globalOrganizationManager.getCollaborationComponent('dev-team');
console.log('组件统计:', component.getStats());
console.log('成员列表:', component.getMembers());

// 查看可用工具
const tools = await globalOrganizationManager.getAllCollaborationTools(token);
console.log('可用工具:', tools.map(t => t.name));
```

## 十三、总结

组织架构管理模块通过协作组件和代理执行机制，提供了强大的团队协作能力：

1. **职责分离**: 每个组件代表明确的职责范围
2. **权限管理**: 基于角色的细粒度权限控制
3. **工具隔离**: 通过前缀避免命名冲突
4. **易于集成**: 统一的MCP API接口
5. **事件审计**: 完整的操作日志和事件系统

该模块是构建多用户协作环境的核心组件，适用于团队开发、数据共享、权限管理等场景。