# ğŸš€ å¿«é€Ÿå¼€å§‹ - MCPæ¡†æ¶

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºRBACçš„MCPå·¥å…·æƒé™ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·ç©ºé—´æ¶æ„(v4.0.0)å’Œæ‰§è¡Œå™¨æ¡†æ¶(v3.1.0)ã€‚

**ç‰ˆæœ¬**: v4.0.0 (ç”¨æˆ·ç©ºé—´æ¶æ„) + v3.1.0 (æ‰§è¡Œå™¨æ¡†æ¶)  
**çŠ¶æ€**: âœ… æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### 1. å®‰è£…å’Œç¼–è¯‘
```bash
npm install
npm run build
```

### 2. æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
```bash
# åŸºç¡€ç¼–è¯‘æµ‹è¯•
node test-compilation.js

# æ‰§è¡Œå™¨ç³»ç»Ÿæµ‹è¯•
npx ts-node test-executor-system.ts

# Tokenä¸æ‰§è¡Œå™¨é›†æˆæµ‹è¯•
npx ts-node test-token-executor-integration.ts

# ç”¨æˆ·ç©ºé—´æ¶æ„æµ‹è¯•
npx ts-node test-user-space-architecture.ts
```

### 3. åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå·¥å…· (3æ­¥)

```typescript
// æ­¥éª¤1: åˆ›å»ºå·¥å…·
export const myTool: Tool = {
  name: 'my_tool',
  description: 'æˆ‘çš„å·¥å…·',
  groups: ['public', 'basic'],
  inputSchema: {
    type: 'object',
    properties: { message: { type: 'string' } },
    required: ['message']
  },
  execute: async (args) => ({
    content: [{ type: 'text', text: `ç»“æœ: ${args.message}` }]
  })
};

// æ­¥éª¤2: æ³¨å†Œå·¥å…·
this.basicToolSet.register(myTool);

// æ­¥éª¤3: ç¼–è¯‘æµ‹è¯•
npm run build
```

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### ç»Ÿä¸€æ‰§è¡Œå™¨æ¶æ„ (v4.0.0 - æ¨è)
```
MCPå·¥å…· â†’ ç»Ÿä¸€æ‰§è¡Œå™¨ â†’ æ‰§è¡Œå™¨å·¥å‚ â†’ æ‰§è¡Œå™¨å®ä¾‹
```

**æ ¸å¿ƒæµç¨‹**:
1. **ç”¨æˆ·è°ƒç”¨MCPå·¥å…·** - é€šè¿‡MCPåè®®è®¿é—®å·¥å…·
2. **MCPå·¥å…·è°ƒç”¨ç»Ÿä¸€æ‰§è¡Œå™¨** - å·¥å…·å†…éƒ¨è°ƒç”¨UserSpaceUnifiedExecutor
3. **ç”¨æˆ·ç©ºé—´ç®¡ç†** - UserSpaceManagerè·å–/åˆ›å»ºç”¨æˆ·ç©ºé—´
4. **æ‰§è¡Œå™¨å·¥å‚** - UserSpaceExecutorFactoryä»ç”¨æˆ·ç©ºé—´è·å–è§„åˆ™
5. **æ‰§è¡Œå™¨å®ä¾‹** - æ£€æŸ¥è§„åˆ™å¹¶æ‰§è¡ŒçœŸå®æ“ä½œ

**ç‰¹ç‚¹**:
- âœ… **3å±‚æ¶æ„** - å‡å°‘40%å¤æ‚åº¦
- âœ… **ç»Ÿä¸€ç®¡ç†** - è™šæ‹ŸåŒ–+è§„åˆ™+å¯è§æ€§+é…ç½®ç»Ÿä¸€
- âœ… **æ€§èƒ½ä¼˜åŒ–** - æ‰§è¡Œæµç¨‹ç¼©çŸ­60%
- âœ… **ç”¨æˆ·ç©ºé—´éš”ç¦»** - æ¯ä¸ªTokenç‹¬ç«‹çš„ç”¨æˆ·ç©ºé—´
- âœ… **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** - æ”¯æŒå¼‚æ­¥MCPå·¥å…·è°ƒç”¨
- âœ… **æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ** - ç”¨æˆ·ç©ºé—´å†…æ¶ˆæ¯ä¼ é€’

### å…¼å®¹æ¶æ„ (v3.1.0 - ä¿ç•™)
```
MCPå·¥å…· â†’ ç»Ÿä¸€æ‰§è¡Œå™¨ â†’ æ‰§è¡Œå™¨å·¥å‚ â†’ æ‰§è¡Œå™¨å®ä¾‹
```

**è¯´æ˜**:
- ä¸v4.0ä½¿ç”¨ç›¸åŒçš„åº•å±‚æ¶æ„
- é€šè¿‡UnifiedExecutorLayeræä¾›å…¼å®¹æ¥å£
- å†…éƒ¨è°ƒç”¨æµç¨‹ä¸v4.0ä¸€è‡´
- ç”¨äºå‘åå…¼å®¹ç°æœ‰ä»£ç 

**ç‰¹ç‚¹**:
- 4ç§æ‰§è¡Œå™¨ç±»å‹
- Tokenè§„åˆ™ç‹¬ç«‹ç®¡ç†
- é…ç½®ç®€æ´ï¼Œæ˜“æ‰©å±•

## ğŸ” æƒé™æ¨¡å‹

### è§’è‰² â†’ ç»„æ˜ å°„
```typescript
user:    ['public', 'basic']
analyst: ['public', 'basic', 'advanced', 'sensitive', 'data-group']
admin:   ['*']  // æ‰€æœ‰ç»„
```

### å·¥å…·åˆ†ç»„
- `public` - å…¬å…±å·¥å…·
- `basic` - åŸºç¡€å·¥å…·
- `advanced` - é«˜çº§å·¥å…·
- `sensitive` - æ•æ„Ÿæ“ä½œ
- `data-group` - æ•°æ®å¤„ç†
- `file-io` - æ–‡ä»¶æ“ä½œ
- `admin-only` - ç®¡ç†å‘˜ä¸“ç”¨
- `token-management` - Tokenç®¡ç†
- `userspace-management` - ç”¨æˆ·ç©ºé—´ç®¡ç†

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ç”¨æˆ·ç©ºé—´æ¶æ„ (æ¨è)
```typescript
import { UserSpaceUnifiedExecutor, globalUserSpaceManager, userSpaceManagementTools } from './src/index';

// 1. åˆ›å»ºToken
const token = tokenManager.createToken('user', 'ç”¨æˆ·Token');

// 2. è·å–ç”¨æˆ·ç©ºé—´
const userSpace = globalUserSpaceManager.getUserSpace(token, 'user');

// 3. è®¾ç½®æ‰§è¡Œå™¨è§„åˆ™
await userSpaceManagementTools[1].execute({
  token,
  executorId: 'filesystem',
  rules: { autoApprove: true, maxFileSize: 1024 * 1024 }
});

// 4. æ‰§è¡Œå·¥å…·
const executor = new UserSpaceUnifiedExecutor();
const result = await executor.executeTool(tool, args, token);
```

### ç¤ºä¾‹2: æ‰§è¡Œå™¨æ¡†æ¶ (å…¼å®¹)
```typescript
import { UnifiedExecutorLayer, ruleManagementTools, setRuleManager } from './src/index';

// 1. åˆå§‹åŒ–
const executor = new UnifiedExecutorLayer('./data');
setRuleManager(executor.getRuleManager());

// 2. è®¾ç½®è§„åˆ™
await ruleManagementTools[0].execute({
  token: 'user_token',
  executorId: 'filesystem',
  rules: { autoApprove: true, maxFileSize: 1024 * 1024 }
});

// 3. æ‰§è¡Œå·¥å…·
const result = await executor.executeTool(tool, args, 'user_token');
```

### ç¤ºä¾‹3: è§„åˆ™ç®¡ç†
```typescript
// è®¾ç½®Tokenè§„åˆ™
await ruleManagementTools[0].execute({
  token: 'user_token',
  executorId: 'network',
  rules: {
    autoApprove: false,
    approver: 'admin',
    timeout: 30000,
    allowedDomains: ['api.example.com']
  }
});

// æŸ¥çœ‹è§„åˆ™
const rules = await ruleManagementTools[1].execute({ token: 'user_token' });

// åˆ é™¤è§„åˆ™
await ruleManagementTools[2].execute({
  token: 'user_token',
  executorId: 'system'
});

// è®¾ç½®é»˜è®¤è§„åˆ™
await ruleManagementTools[3].execute({
  executorId: 'filesystem',
  rules: { autoApprove: true, maxFileSize: 1024 * 1024 }
});
```

## âš™ï¸ æ‰§è¡Œå™¨ç±»å‹

### 1. FileSystemExecutor
- **å·¥å…·å‰ç¼€**: `file_`
- **åŠŸèƒ½**: æ–‡ä»¶è¯»å†™åˆ é™¤
- **è§„åˆ™**: autoApprove, maxFileSize, maxCalls

### 2. NetworkExecutor  
- **å·¥å…·å‰ç¼€**: `http_`
- **åŠŸèƒ½**: HTTPè¯·æ±‚ã€ä¸‹è½½
- **è§„åˆ™**: autoApprove, timeout, allowedDomains, maxCalls

### 3. SystemExecutor
- **å·¥å…·å‰ç¼€**: `exec_`
- **åŠŸèƒ½**: ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ
- **è§„åˆ™**: autoApprove, approver, allowedCommands, maxCalls

### 4. DefaultExecutor
- **é»˜è®¤ç±»å‹**: æœªæŒ‡å®šæ—¶ä½¿ç”¨
- **åŠŸèƒ½**: ç›´æ¥è°ƒç”¨å·¥å…·execute
- **è§„åˆ™**: autoApprove, maxCalls

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### v4.0.0 ç”¨æˆ·ç©ºé—´æ¶æ„
1. **æ¶æ„ç®€åŒ–** - ä»5å±‚å‡å°‘åˆ°3å±‚ï¼Œå‡å°‘40%
2. **åŠŸèƒ½é›†æˆ** - è™šæ‹ŸåŒ–+è§„åˆ™+å¯è§æ€§+é…ç½®ç»Ÿä¸€ç®¡ç†
3. **æ€§èƒ½ä¼˜åŒ–** - æ‰§è¡Œæµç¨‹ç¼©çŸ­60%
4. **æ‰©å±•æ€§å¼º** - ç”¨æˆ·ç©ºé—´å¯è½»æ¾æ·»åŠ æ–°åŠŸèƒ½
5. **ç»´æŠ¤ç®€å•** - ç›¸å…³åŠŸèƒ½é›†ä¸­ï¼Œä¿®æ”¹å½±å“èŒƒå›´å°
6. **å¼‚æ­¥æ”¯æŒ** - å†…ç½®å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—
7. **æ¶ˆæ¯ä¼ é€’** - ç”¨æˆ·ç©ºé—´å†…æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ

### v3.1.0 æ‰§è¡Œå™¨æ¶æ„
1. **é…ç½®ç®€æ´** - åªéœ€ç»„æ ‡ç­¾å’Œè§’è‰²æƒé™
2. **æ— å†²çª** - ç™½åå•æ¨¡å¼é¿å…å†…å¤–å±‚å†²çª
3. **æ˜“æ‰©å±•** - æ–°å¢å·¥å…·åªéœ€åˆ†é…ç»„æ ‡ç­¾
4. **Tokenç®¡ç†** - å®Œæ•´çš„Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†
5. **ç»Ÿä¸€æ‰§è¡Œå™¨** - æ‰€æœ‰æƒé™æ“ä½œç»è¿‡ç»Ÿä¸€æ‰§è¡Œå™¨å±‚
6. **Tokenè§„åˆ™ç®¡ç†** - æ¯ä¸ªTokenç‹¬ç«‹è§„åˆ™ï¼Œæ”¯æŒåŠ¨æ€ä¿®æ”¹

## ğŸ§ª æµ‹è¯•éªŒè¯

æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…ï¼š

| æµ‹è¯•æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|---------|------|------|
| test-compilation.js | åŸºç¡€ç¼–è¯‘å’Œæ ¸å¿ƒåŠŸèƒ½ | âœ… |
| test-executor-system.ts | æ‰§è¡Œå™¨ç³»ç»Ÿå®Œæ•´æµ‹è¯• | âœ… |
| test-token-executor-integration.ts | Tokenä¸æ‰§è¡Œå™¨é›†æˆ | âœ… |
| test-user-space-architecture.ts | ç”¨æˆ·ç©ºé—´æ¶æ„ | âœ… |

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°å·¥å…·
```typescript
// 1. åˆ›å»ºå·¥å…·
export const myTool: Tool = {
  name: 'my_tool',
  description: 'æˆ‘çš„å·¥å…·',
  groups: ['public', 'basic'],
  inputSchema: {
    type: 'object',
    properties: { message: { type: 'string' } },
    required: ['message']
  },
  execute: async (args) => ({
    content: [{ type: 'text', text: `ç»“æœ: ${args.message}` }]
  })
};

// 2. æ³¨å†Œåˆ°å®¹å™¨
this.basicToolSet.register(myTool);

// 3. ç¼–è¯‘æµ‹è¯•
npm run build
```

### æ·»åŠ è‡ªå®šä¹‰æ‰§è¡Œå™¨
```typescript
// 1. å®ç°å·¥å‚
class CustomExecutorFactory implements IExecutorFactory {
  async create(tool: Tool, token: string): Promise<ExecutorInstance> {
    const rules = await ruleManager.getRules(token, 'custom');
    return new CustomExecutorInstance(tool, rules);
  }
}

// 2. æ³¨å†Œæ‰§è¡Œå™¨
executorFactory.register('custom', new CustomExecutorFactory(ruleManager));

// 3. ä½¿ç”¨
const tool: Tool = {
  name: 'custom_tool',
  executor: { type: 'custom' },
  execute: async (args) => ({ content: [{ type: 'text', text: 'ç»“æœ' }] })
};
```

## ğŸ“¦ å¯¼å‡ºç»„ä»¶

```typescript
// æ ¸å¿ƒç»„ä»¶
export { UserSpaceUnifiedExecutor, UserSpaceExecutorFactory, UserSpaceManager }
export { UnifiedExecutorLayer, ExecutorFactory, TokenRuleManager, TokenManager }

// å·¥å…·é›†åˆ
export { userSpaceManagementTools }  // 14ä¸ª
export { ruleManagementTools }       // 5ä¸ª
export { tokenManagementTools }      // 9ä¸ª
export { virtualizationManagementTools }  // 8ä¸ª
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œå™¨é€‰æ‹©**: å·¥å…·è‡ªå£°æ˜ > è‡ªåŠ¨æ¨æ–­ > é»˜è®¤æ‰§è¡Œå™¨
2. **è§„åˆ™ä¼˜å…ˆçº§**: Tokenç‰¹å®šè§„åˆ™ > é»˜è®¤è§„åˆ™
3. **æ€§èƒ½è€ƒè™‘**: æ–‡ä»¶å­˜å‚¨é€‚åˆä¸­å°è§„æ¨¡
4. **å®‰å…¨è€ƒè™‘**: ç³»ç»Ÿæ‰§è¡Œå™¨é»˜è®¤éœ€è¦å®¡æ‰¹

## ğŸ“š å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### å¼€å‘æµ‹è¯•
```bash
# ç¼–è¯‘é¡¹ç›®
npm run build

# æµ‹è¯•å·¥å…·åˆ—è¡¨
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | node build/index.js

# æµ‹è¯•å·¥å…·æ‰§è¡Œ
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"echo","arguments":{"message":"test"}}}' | node build/index.js

# åˆ‡æ¢è§’è‰²æµ‹è¯•
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"switch_role","arguments":{"role":"admin"}}}' | node build/index.js
```

### Tokenæ“ä½œ
```bash
# åˆ›å»ºTokenï¼ˆéœ€è¦adminè§’è‰²ï¼‰
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"token_create","arguments":{"role":"analyst","description":"æˆ‘çš„token","expiresIn":"2h"}}}' | node build/index.js

# ä½¿ç”¨Tokenè·å–å·¥å…·åˆ—è¡¨
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{"_meta":{"token":"your-token"}}}' | node build/index.js

# éªŒè¯Token
echo '{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"validate_token","arguments":{"token":"your-token"}}}' | node build/index.js
```

## ğŸ’¡ å…³é”®æç¤º

### âœ… å¿…é¡»éµå®ˆ
1. **å·¥å…·å¿…é¡»æœ‰groupsæ ‡ç­¾** - å¦åˆ™ä¸å¯è§
2. **å‚æ•°å¿…é¡»éªŒè¯** - é˜²æ­¢è¿è¡Œæ—¶é”™è¯¯
3. **è¿”å›ToolResultæ ¼å¼** - ç¬¦åˆMCPåè®®
4. **æ³¨å†Œåˆ°æ­£ç¡®å®¹å™¨** - åŸºç¡€/é«˜çº§/æ‰©å±•å®¹å™¨

### âš ï¸ å¸¸è§é”™è¯¯
1. **å·¥å…·ä¸å¯è§** - æ£€æŸ¥groupsæ ‡ç­¾å’Œè§’è‰²æƒé™
2. **æƒé™æ‹’ç»** - ç¡®è®¤è§’è‰²çš„allowedGroupsåŒ…å«å·¥å…·groups
3. **å‚æ•°é”™è¯¯** - ä¸¥æ ¼éªŒè¯è¾“å…¥å‚æ•°
4. **ç¼–è¯‘å¤±è´¥** - æ£€æŸ¥ç±»å‹å®šä¹‰å’Œå¯¼å…¥

### ğŸ¯ æœ€ä½³å®è·µ
1. **å•ä¸€èŒè´£** - æ¯ä¸ªå·¥å…·åªåšä¸€ä»¶äº‹
2. **æœ€å°æƒé™** - åªåˆ†é…å¿…è¦çš„groups
3. **æ¸…æ™°æè¿°** - å·¥å…·å’Œå‚æ•°éƒ½è¦æœ‰è¯¦ç»†æè¿°
4. **å®Œæ•´æµ‹è¯•** - éªŒè¯æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µ

---

**ä¸‹ä¸€æ­¥**: ä» [01_å·¥å…·å¼€å‘åŸºç¡€.md](01_å·¥å…·å¼€å‘åŸºç¡€.md) å¼€å§‹å­¦ä¹ 