# 03_æ¡†æ¶æ¶æ„æ ¸å¿ƒ

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£æ‰§è¡Œå™¨æ¡†æ¶æ¶æ„
- æŒæ¡4ç§æ‰§è¡Œå™¨ç±»å‹
- å­¦ä¼šTokenè§„åˆ™ç®¡ç†

## ğŸ—ï¸ æ‰§è¡Œå™¨æ¡†æ¶æ¶æ„

```
MCPå·¥å…· â†’ ç»Ÿä¸€æ‰§è¡Œå™¨ â†’ æ‰§è¡Œå™¨å·¥å‚ â†’ æ‰§è¡Œå™¨å®ä¾‹
```

**è¯´æ˜**: è¿™æ˜¯v3.1.0å…¼å®¹æ¶æ„ï¼Œåº•å±‚ä¸v4.0ç”¨æˆ·ç©ºé—´æ¶æ„ç›¸åŒã€‚æ¨èä½¿ç”¨v4.0è·å¾—å®Œæ•´åŠŸèƒ½ã€‚

### æ ¸å¿ƒç»„ä»¶

#### 1. UnifiedExecutorLayerï¼ˆç»Ÿä¸€æ‰§è¡Œå™¨å±‚ - å…¼å®¹æ¥å£ï¼‰
```typescript
class UnifiedExecutorLayer {
  constructor(dataPath: string)
  
  // æ‰§è¡Œå·¥å…·
  async executeTool(tool: Tool, args: any, token: string): Promise<ToolResult>
  
  // è·å–è§„åˆ™ç®¡ç†å™¨
  getRuleManager(): TokenRuleManager
  
  // è·å–æ‰§è¡Œå™¨å·¥å‚
  getExecutorFactory(): ExecutorFactory
}
```

#### 2. ExecutorFactoryï¼ˆæ‰§è¡Œå™¨å·¥å‚ï¼‰
```typescript
class ExecutorFactory {
  // æ³¨å†Œæ‰§è¡Œå™¨ç±»å‹
  register(type: string, factory: IExecutorFactory): void
  
  // åˆ›å»ºæ‰§è¡Œå™¨å®ä¾‹
  async create(tool: Tool, token: string): Promise<ExecutorInstance>
  
  // è·å–æ‰§è¡Œå™¨ç±»å‹
  getExecutorType(tool: Tool): string
}
```

#### 3. TokenRuleManagerï¼ˆTokenè§„åˆ™ç®¡ç†å™¨ï¼‰
```typescript
class TokenRuleManager {
  // è®¾ç½®Tokenè§„åˆ™
  async setRules(token: string, executorId: string, rules: ExecutorRules): Promise<void>
  
  // è·å–Tokenè§„åˆ™
  async getRules(token: string, executorId: string): Promise<ExecutorRules | null>
  
  // åˆ é™¤Tokenè§„åˆ™
  async deleteRules(token: string, executorId: string): Promise<void>
  
  // è®¾ç½®é»˜è®¤è§„åˆ™
  async setDefaultRules(executorId: string, rules: ExecutorRules): Promise<void>
  
  // è·å–é»˜è®¤è§„åˆ™
  async getDefaultRules(executorId: string): Promise<ExecutorRules | null>
}
```

## âš™ï¸ æ‰§è¡Œå™¨ç±»å‹

### 1. FileSystemExecutor
- **å·¥å…·å‰ç¼€**: `file_`
- **åŠŸèƒ½**: æ–‡ä»¶è¯»å†™åˆ é™¤
- **è§„åˆ™**: 
  - `autoApprove`: boolean - è‡ªåŠ¨æ‰¹å‡†
  - `maxFileSize`: number - æœ€å¤§æ–‡ä»¶å¤§å°
  - `maxCalls`: number - æœ€å¤§è°ƒç”¨æ¬¡æ•°

### 2. NetworkExecutor
- **å·¥å…·å‰ç¼€**: `http_`
- **åŠŸèƒ½**: HTTPè¯·æ±‚ã€ä¸‹è½½
- **è§„åˆ™**: 
  - `autoApprove`: boolean - è‡ªåŠ¨æ‰¹å‡†
  - `timeout`: number - è¶…æ—¶æ—¶é—´
  - `allowedDomains`: string[] - å…è®¸çš„åŸŸå
  - `maxCalls`: number - æœ€å¤§è°ƒç”¨æ¬¡æ•°

### 3. SystemExecutor
- **å·¥å…·å‰ç¼€**: `exec_`
- **åŠŸèƒ½**: ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ
- **è§„åˆ™**: 
  - `autoApprove`: boolean - è‡ªåŠ¨æ‰¹å‡†
  - `approver`: string - å®¡æ‰¹äººè§’è‰²
  - `allowedCommands`: string[] - å…è®¸çš„å‘½ä»¤
  - `maxCalls`: number - æœ€å¤§è°ƒç”¨æ¬¡æ•°

### 4. DefaultExecutor
- **é»˜è®¤ç±»å‹**: æœªæŒ‡å®šæ—¶ä½¿ç”¨
- **åŠŸèƒ½**: ç›´æ¥è°ƒç”¨å·¥å…·execute
- **è§„åˆ™**: 
  - `autoApprove`: boolean - è‡ªåŠ¨æ‰¹å‡†
  - `maxCalls`: number - æœ€å¤§è°ƒç”¨æ¬¡æ•°

## ğŸ” Tokenè§„åˆ™ç®¡ç†

### è§„åˆ™è®¾ç½®ç¤ºä¾‹

```typescript
import { ruleManagementTools } from './src/index';

// 1. è®¾ç½®Tokenç‰¹å®šè§„åˆ™
await ruleManagementTools[0].execute({
  token: 'user_token',
  executorId: 'filesystem',
  rules: {
    autoApprove: true,
    maxFileSize: 1024 * 1024,
    maxCalls: 100
  }
});

// 2. è·å–è§„åˆ™
const rules = await ruleManagementTools[1].execute({ 
  token: 'user_token' 
});

// 3. åˆ é™¤è§„åˆ™
await ruleManagementTools[2].execute({
  token: 'user_token',
  executorId: 'filesystem'
});

// 4. è®¾ç½®é»˜è®¤è§„åˆ™
await ruleManagementTools[3].execute({
  executorId: 'filesystem',
  rules: { autoApprove: true, maxFileSize: 1024 * 1024 }
});

// 5. è·å–é»˜è®¤è§„åˆ™
const defaultRules = await ruleManagementTools[4].execute({
  executorId: 'filesystem'
});
```

### è§„åˆ™ä¼˜å…ˆçº§

```
Tokenç‰¹å®šè§„åˆ™ > é»˜è®¤è§„åˆ™ > æ‰§è¡Œå™¨é»˜è®¤è¡Œä¸º
```

## ğŸ“Š æ‰§è¡Œæµç¨‹

### 1. å·¥å…·æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚æ‰§è¡Œå·¥å…·
    â†“
è·å–Tokenå’Œå·¥å…·ä¿¡æ¯
    â†“
æ‰§è¡Œå™¨å·¥å‚ç¡®å®šæ‰§è¡Œå™¨ç±»å‹
    â†“
è·å–Tokenè§„åˆ™ï¼ˆæˆ–é»˜è®¤è§„åˆ™ï¼‰
    â†“
åˆ›å»ºæ‰§è¡Œå™¨å®ä¾‹
    â†“
æ‰§è¡Œå™¨æ£€æŸ¥æƒé™å’Œè§„åˆ™
    â†“
æ‰§è¡Œå·¥å…·é€»è¾‘
    â†“
è¿”å›ç»“æœ
```

### 2. æƒé™æ£€æŸ¥æµç¨‹

```typescript
// åœ¨æ‰§è¡Œå™¨å®ä¾‹ä¸­
async execute(args: any): Promise<ToolResult> {
  // 1. æ£€æŸ¥è‡ªåŠ¨æ‰¹å‡†
  if (!this.rules.autoApprove) {
    throw new Error(`éœ€è¦å®¡æ‰¹: ${this.rules.approver}`);
  }
  
  // 2. æ£€æŸ¥è°ƒç”¨æ¬¡æ•°é™åˆ¶
  if (this.rules.maxCalls && this.callCount >= this.rules.maxCalls) {
    throw new Error('å·²è¾¾åˆ°æœ€å¤§è°ƒç”¨æ¬¡æ•°');
  }
  
  // 3. æ‰§è¡Œå™¨ç‰¹å®šæ£€æŸ¥
  await this.validateExecution(args);
  
  // 4. æ‰§è¡Œå·¥å…·
  const result = await this.tool.execute(args);
  
  // 5. æ›´æ–°è°ƒç”¨è®¡æ•°
  this.callCount++;
  
  return result;
}
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œå™¨

```typescript
// å®šä¹‰æ–‡ä»¶è¯»å–å·¥å…·
const fileReadTool: Tool = {
  name: 'file_read',
  description: 'è¯»å–æ–‡ä»¶å†…å®¹',
  groups: ['file-io', 'public'],
  inputSchema: {
    type: 'object',
    properties: {
      path: { type: 'string', description: 'æ–‡ä»¶è·¯å¾„' }
    },
    required: ['path']
  },
  execute: async (args) => {
    const content = await fs.readFile(args.path, 'utf-8');
    return {
      content: [{ type: 'text', text: content }]
    };
  }
};

// è®¾ç½®è§„åˆ™
await ruleManagementTools[0].execute({
  token: 'user_token',
  executorId: 'filesystem',
  rules: {
    autoApprove: true,
    maxFileSize: 1024 * 1024,
    maxCalls: 50
  }
});

// æ‰§è¡Œ
const executor = new UnifiedExecutorLayer('./data');
const result = await executor.executeTool(fileReadTool, { path: '/tmp/test.txt' }, 'user_token');
```

### ç¤ºä¾‹2: ç½‘ç»œæ‰§è¡Œå™¨

```typescript
const httpTool: Tool = {
  name: 'http_request',
  description: 'å‘é€HTTPè¯·æ±‚',
  groups: ['network', 'advanced'],
  executor: { type: 'network' },
  inputSchema: {
    type: 'object',
    properties: {
      url: { type: 'string' },
      method: { type: 'string', enum: ['GET', 'POST'] }
    },
    required: ['url']
  },
  execute: async (args) => {
    // å®é™…HTTPè¯·æ±‚é€»è¾‘
    return { content: [{ type: 'text', text: 'å“åº”æ•°æ®' }] };
  }
};

// è®¾ç½®ç½‘ç»œè§„åˆ™
await ruleManagementTools[0].execute({
  token: 'analyst_token',
  executorId: 'network',
  rules: {
    autoApprove: false,
    approver: 'admin',
    timeout: 30000,
    allowedDomains: ['api.example.com', 'data.company.com'],
    maxCalls: 100
  }
});
```

### ç¤ºä¾‹3: ç³»ç»Ÿæ‰§è¡Œå™¨

```typescript
const execTool: Tool = {
  name: 'exec_command',
  description: 'æ‰§è¡Œç³»ç»Ÿå‘½ä»¤',
  groups: ['admin-only', 'sensitive'],
  executor: { type: 'system' },
  inputSchema: {
    type: 'object',
    properties: {
      command: { type: 'string' }
    },
    required: ['command']
  },
  execute: async (args) => {
    // æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
    return { content: [{ type: 'text', text: 'å‘½ä»¤æ‰§è¡Œç»“æœ' }] };
  }
};

// è®¾ç½®ç³»ç»Ÿè§„åˆ™ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
await ruleManagementTools[0].execute({
  token: 'admin_token',
  executorId: 'system',
  rules: {
    autoApprove: false,
    approver: 'admin',
    allowedCommands: ['ls', 'cat', 'echo'],
    maxCalls: 10
  }
});
```

## ğŸ§ª æµ‹è¯•æ‰§è¡Œå™¨

### æµ‹è¯•å·¥å…·åˆ—è¡¨

```bash
# æŸ¥çœ‹æ‰€æœ‰å·¥å…·
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | node build/index.js

# ä½¿ç”¨TokenæŸ¥çœ‹å·¥å…·
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{"_meta":{"token":"your-token"}}}' | node build/index.js
```

### æµ‹è¯•è§„åˆ™ç®¡ç†

```bash
# è®¾ç½®è§„åˆ™ï¼ˆéœ€è¦adminè§’è‰²ï¼‰
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"set_executor_rule","arguments":{"token":"user_token","executorId":"filesystem","rules":{"autoApprove":true,"maxFileSize":1024000}}}}' | node build/index.js

# æŸ¥çœ‹è§„åˆ™
echo '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"get_executor_rules","arguments":{"token":"user_token"}}}' | node build/index.js

# è®¾ç½®é»˜è®¤è§„åˆ™
echo '{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"set_default_rule","arguments":{"executorId":"filesystem","rules":{"autoApprove":true,"maxFileSize":524288}}}}' | node build/index.js
```

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### é…ç½®ç®€æ´
- åªéœ€ç»„æ ‡ç­¾å’Œè§’è‰²æƒé™
- Tokenè§„åˆ™ç‹¬ç«‹ç®¡ç†
- é»˜è®¤è§„åˆ™æ”¯æŒ

### æ— å†²çª
- ç™½åå•æ¨¡å¼é¿å…å†…å¤–å±‚å†²çª
- è§„åˆ™ä¼˜å…ˆçº§æ¸…æ™°
- æ‰§è¡Œå™¨ç±»å‹æ˜ç¡®

### æ˜“æ‰©å±•
- æ–°å¢å·¥å…·åªéœ€åˆ†é…ç»„æ ‡ç­¾
- æ–°å¢æ‰§è¡Œå™¨åªéœ€å®ç°æ¥å£
- è§„åˆ™ç³»ç»Ÿçµæ´»

### Tokenç®¡ç†
- å®Œæ•´çš„Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ¯ä¸ªTokenç‹¬ç«‹è§„åˆ™
- æ”¯æŒåŠ¨æ€ä¿®æ”¹

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œå™¨é€‰æ‹©**: å·¥å…·è‡ªå£°æ˜ > è‡ªåŠ¨æ¨æ–­ > é»˜è®¤æ‰§è¡Œå™¨
2. **è§„åˆ™ä¼˜å…ˆçº§**: Tokenç‰¹å®šè§„åˆ™ > é»˜è®¤è§„åˆ™
3. **æ€§èƒ½è€ƒè™‘**: æ–‡ä»¶å­˜å‚¨é€‚åˆä¸­å°è§„æ¨¡
4. **å®‰å…¨è€ƒè™‘**: ç³»ç»Ÿæ‰§è¡Œå™¨é»˜è®¤éœ€è¦å®¡æ‰¹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å·¥å…·å¼€å‘**ï¼š[01_å·¥å…·å¼€å‘åŸºç¡€.md](01_å·¥å…·å¼€å‘åŸºç¡€.md)
- **æƒé™æ§åˆ¶**ï¼š[02_æƒé™æ§åˆ¶è¯¦è§£.md](02_æƒé™æ§åˆ¶è¯¦è§£.md)
- **Tokenç®¡ç†**ï¼š[05_Tokenç®¡ç†ç³»ç»Ÿ.md](05_Tokenç®¡ç†ç³»ç»Ÿ.md)

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [04_é…ç½®ç³»ç»Ÿä½¿ç”¨.md](04_é…ç½®ç³»ç»Ÿä½¿ç”¨.md)