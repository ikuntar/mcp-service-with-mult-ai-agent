# 02_æƒé™æ§åˆ¶è¯¦è§£

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£RBACæƒé™æ¨¡å‹
- æŒæ¡è§’è‰²å’Œç»„çš„æ˜ å°„å…³ç³»
- å­¦ä¼šæƒé™æ£€æŸ¥æµç¨‹

## ğŸ” RBACæƒé™æ¨¡å‹

### æ ¸å¿ƒæ¦‚å¿µ

**RBAC (Role-Based Access Control)** - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

```
ç”¨æˆ· â†’ è§’è‰² â†’ ç»„ â†’ å·¥å…·
```

### è§’è‰²å®šä¹‰

```typescript
// src/index.ts ä¸­çš„è§’è‰²é…ç½®
const basicConfig: ContainerConfig = {
  name: 'åŸºç¡€å·¥å…·é›†',
  description: 'åŸºç¡€å·¥å…·ï¼Œæ‰€æœ‰ç”¨æˆ·å¯ç”¨',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'æ™®é€šç”¨æˆ·',
      allowedGroups: ['public', 'basic']
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'basic', 'advanced', 'sensitive', 'data-group']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']  // é€šé…ç¬¦ï¼Œè®¿é—®æ‰€æœ‰ç»„
    }
  }
};
```

### è§’è‰² â†’ ç»„æ˜ å°„

| è§’è‰² | å…è®¸çš„ç»„ | å¯è§å·¥å…·ç¤ºä¾‹ |
|------|----------|--------------|
| **user** | `['public', 'basic']` | echo, add, validate_token |
| **analyst** | `['public', 'basic', 'advanced', 'sensitive', 'data-group']` | + demo_tool, data_filter, data_sort |
| **admin** | `['*']` | æ‰€æœ‰å·¥å…· + Tokenç®¡ç†å·¥å…· |

### å·¥å…· â†’ ç»„æ˜ å°„

```typescript
// åŸºç¡€å·¥å…·
echoTool.groups = ['public', 'basic'];
addTool.groups = ['public', 'basic'];

// TokenæŸ¥è¯¢å·¥å…·
validateTokenTool.groups = ['public', 'token-based-fetcher'];
getTokenRoleInfoTool.groups = ['public', 'token-based-fetcher'];

// æ¼”ç¤ºå·¥å…·
demoTool.groups = ['advanced', 'sensitive'];

// æ•°æ®å¤„ç†å·¥å…·
filterTool.groups = ['data-group', 'sensitive'];
sortTool.groups = ['data-group'];
transformTool.groups = ['data-group'];
aggregateTool.groups = ['data-group'];

// æ–‡ä»¶æ“ä½œå·¥å…·
fileReadTool.groups = ['file-io', 'public'];
fileWriteTool.groups = ['file-io', 'public'];
fileSearchTool.groups = ['file-io', 'public'];
fileClearCacheTool.groups = ['file-io', 'admin-only'];

// Tokenç®¡ç†å·¥å…·
createTokenTool.groups = ['admin-only', 'token-management'];
validateTokenTool.groups = ['admin-only', 'token-management'];

// è§’è‰²åˆ‡æ¢å·¥å…·
switchRoleTool.groups = ['public', 'admin-only'];
```

## ğŸ”„ æƒé™æ£€æŸ¥æµç¨‹

### 1. å·¥å…·åˆ—è¡¨è¯·æ±‚æµç¨‹

```
ç”¨æˆ·è¯·æ±‚å·¥å…·åˆ—è¡¨
    â†“
è·å–å½“å‰è§’è‰²ï¼ˆä»tokenæˆ–é»˜è®¤è§’è‰²ï¼‰
    â†“
æŒ‰å®¹å™¨æ£€æŸ¥æƒé™
    â†“
â”Œâ”€â†’ åŸºç¡€å®¹å™¨ â†’ getToolsByRole(role)
â”œâ”€â†’ é«˜çº§å®¹å™¨ â†’ getToolsByRole(role)  
â”œâ”€â†’ æ‰©å±•å®¹å™¨ â†’ getToolsByRole(role)
â”‚   â””â”€â†’ æ•°æ®ç»„ â†’ getToolsByGroup('data-tools', role)
â””â”€â†’ æ’ä»¶å·¥å…· â†’ è¿‡æ»¤æƒé™
    â†“
è¿”å›å¯è§å·¥å…·åˆ—è¡¨
```

### 2. æƒé™æ£€æŸ¥å®ç°

```typescript
// EnhancedToolContainer ä¸­çš„æƒé™æ£€æŸ¥
getToolsByRole(roleName: string): Tool[] {
  const role = this.roleConfig.roles[roleName];
  if (!role) {
    throw new Error(`è§’è‰² "${roleName}" åœ¨å®¹å™¨ "${this.containerName}" ä¸­ä¸å­˜åœ¨`);
  }

  const allTools = this.getRawTools();
  return allTools.filter(tool => {
    // é€šé…ç¬¦ï¼šå…è®¸æ‰€æœ‰ç»„
    if (role.allowedGroups.includes('*')) {
      return true;
    }
    
    // ç™½åå•æ£€æŸ¥ï¼šå·¥å…·groupsä¸è§’è‰²allowedGroupsæœ‰äº¤é›†
    const toolGroups = tool.groups || [];
    return toolGroups.some(group => 
      role.allowedGroups.includes(group)
    );
  });
}

// æ£€æŸ¥ç‰¹å®šå·¥å…·æƒé™
canAccess(roleName: string, toolName: string): boolean {
  const visibleTools = this.getToolsByRole(roleName);
  return visibleTools.some(tool => tool.name === toolName);
}

// å¸¦æƒé™æ£€æŸ¥çš„æ‰§è¡Œ
async executeWithRole(roleName: string, toolName: string, args: any): Promise<ToolResult> {
  if (!this.canAccess(roleName, toolName)) {
    throw new Error(`è§’è‰² "${roleName}" æ— æƒè®¿é—®å·¥å…· "${toolName}"`);
  }
  return await this.execute(toolName, args);
}
```

### 3. Tokenæ”¯æŒçš„è§’è‰²åˆ‡æ¢

```typescript
// åœ¨ tools/list è¯·æ±‚ä¸­
this.server.setRequestHandler(ListToolsRequestSchema, async (request) => {
  // 1. è·å–è§’è‰²ï¼ˆæ”¯æŒtokenå‚æ•°ï¼‰
  let role = this.currentUserRole;
  const meta = (request as any).params?._meta;
  
  if (meta && meta.token) {
    const tokenRole = globalTokenManager.validateToken(meta.token);
    if (tokenRole) {
      role = tokenRole;
      console.log(`[Server] ä½¿ç”¨TokenéªŒè¯ï¼Œè§’è‰²: ${role}`);
    } else {
      console.log(`[Server] Tokenæ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤è§’è‰²: ${role}`);
    }
  }
  
  // 2. æ”¶é›†æ‰€æœ‰å¯è§å·¥å…·
  const allTools = [];
  allTools.push(...this.basicToolSet.getToolsByRole(role));
  allTools.push(...this.advancedToolSet.getToolsByRole(role));
  allTools.push(...this.extendedToolSet.getToolsByRole(role));
  
  // 3. å¤„ç†æ’ä»¶å·¥å…·
  for (const plugin of this.pluginManager.values()) {
    if (plugin.getTools) {
      const pluginTools = plugin.getTools();
      // åˆ›å»ºä¸´æ—¶å®¹å™¨åº”ç”¨é…ç½®æ¨¡å¼
      const pluginContainer = new EnhancedToolContainer(/* ... */);
      pluginTools.forEach(tool => pluginContainer.register(tool));
      allTools.push(...pluginContainer.getDisplayTools(role));
    }
  }
  
  // 4. è½¬æ¢ä¸ºMCPæ ¼å¼
  const tools = allTools.map(tool => ({
    name: tool.name,
    description: tool.description,
    inputSchema: tool.inputSchema,
  }));
  
  return { tools };
});
```

## ğŸ› ï¸ æƒé™é…ç½®ç¤ºä¾‹

### 1. åˆ›å»ºæ–°å®¹å™¨é…ç½®

```typescript
// src/index.ts
const newContainerConfig: ContainerConfig = {
  name: 'æ–°å·¥å…·é›†',
  description: 'æ–°å¢çš„å·¥å…·å®¹å™¨',
  defaultRole: 'user',
  roles: {
    'user': {
      name: 'æ™®é€šç”¨æˆ·',
      allowedGroups: ['public', 'new-features']
    },
    'analyst': {
      name: 'åˆ†æå¸ˆ',
      allowedGroups: ['public', 'new-features', 'advanced']
    },
    'admin': {
      name: 'ç®¡ç†å‘˜',
      allowedGroups: ['*']
    }
  }
};

// åˆ›å»ºå®¹å™¨
const newContainer = new EnhancedToolContainer(
  'æ–°å·¥å…·é›†', 
  'new-type', 
  newContainerConfig
);

// æ³¨å†Œå·¥å…·
newContainer.register(newTool);
```

### 2. ä¸ºå·¥å…·åˆ†é…ç»„æ ‡ç­¾

```typescript
// ä½æƒé™å·¥å…·
export const publicTool: Tool = {
  name: 'public_tool',
  groups: ['public', 'basic'],
  // ...
};

// ä¸­ç­‰æƒé™å·¥å…·
export const dataTool: Tool = {
  name: 'data_tool',
  groups: ['data-group', 'sensitive'],
  // ...
};

// é«˜æƒé™å·¥å…·
export const adminTool: Tool = {
  name: 'admin_tool',
  groups: ['admin-only', 'sensitive'],
  // ...
};
```

## ğŸ” å¸¸è§æƒé™é—®é¢˜

### é—®é¢˜1: å·¥å…·ä¸å¯è§

**ç—‡çŠ¶**ï¼šå·¥å…·åˆ—è¡¨ä¸­çœ‹ä¸åˆ°æŸä¸ªå·¥å…·

**åŸå› åˆ†æ**ï¼š
```typescript
// âŒ é”™è¯¯ï¼šå·¥å…·æ²¡æœ‰groupsæ ‡ç­¾
export const badTool: Tool = {
  name: 'bad_tool',
  // ç¼ºå°‘ groups: ['public']
  execute: async (args) => ({ content: [{ type: 'text', text: 'result' }] })
};

// âŒ é”™è¯¯ï¼šå·¥å…·groupsä¸åœ¨è§’è‰²çš„allowedGroupsä¸­
export const tool: Tool = {
  groups: ['admin-only']  // userè§’è‰²æ²¡æœ‰è¿™ä¸ªç»„
};

// âœ… æ­£ç¡®
export const goodTool: Tool = {
  groups: ['public', 'basic'],  // userè§’è‰²æœ‰è¿™äº›ç»„
  execute: async (args) => ({ content: [{ type: 'text', text: 'result' }] })
};
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥å·¥å…·æ˜¯å¦åˆ†é…äº†groupsæ ‡ç­¾
2. ç¡®è®¤å½“å‰è§’è‰²çš„allowedGroupsåŒ…å«è¯¥ç»„
3. éªŒè¯å·¥å…·æ˜¯å¦æ­£ç¡®æ³¨å†Œåˆ°å®¹å™¨

### é—®é¢˜2: æƒé™æ‹’ç»é”™è¯¯

**ç—‡çŠ¶**ï¼šæ‰§è¡Œå·¥å…·æ—¶æç¤º"æ— æƒè®¿é—®"

**åŸå› åˆ†æ**ï¼š
```typescript
// å½“å‰è§’è‰²: user
// å·¥å…·groups: ['admin-only']
// user.allowedGroups: ['public', 'basic']

// æ£€æŸ¥ç»“æœ: false (æ— äº¤é›†)
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åˆ‡æ¢åˆ°æ›´é«˜æƒé™è§’è‰²
2. ä¿®æ”¹å·¥å…·groupsæ ‡ç­¾
3. ä¿®æ”¹è§’è‰²é…ç½®

### é—®é¢˜3: Tokenæ— æ•ˆ

**ç—‡çŠ¶**ï¼šä½¿ç”¨Tokenè·å–å·¥å…·åˆ—è¡¨å¤±è´¥

**åŸå› åˆ†æ**ï¼š
```typescript
// Tokenå¯èƒ½å·²è¿‡æœŸ
const tokenInfo = globalTokenManager.getTokenInfo(token);
if (tokenInfo.expiresAt && new Date(tokenInfo.expiresAt) < new Date()) {
  console.log('Tokenå·²è¿‡æœŸ');
}

// Tokenè¢«ç¦ç”¨
if (!tokenInfo.isActive) {
  console.log('Tokenå·²è¢«ç¦ç”¨');
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ `token_info` å·¥å…·æŸ¥çœ‹TokençŠ¶æ€
2. ä½¿ç”¨ `token_renew` å·¥å…·ç»­æœŸ
3. ä½¿ç”¨ `token_activate` å·¥å…·æ¿€æ´»
4. åˆ›å»ºæ–°Token

## ğŸ§ª æƒé™æµ‹è¯•

### 1. æµ‹è¯•ä¸åŒè§’è‰²çš„å·¥å…·å¯è§æ€§

```bash
# é»˜è®¤è§’è‰² (user)
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | node build/index.js

# åˆ‡æ¢åˆ°analystè§’è‰²
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"switch_role","arguments":{"role":"analyst"}}}' | node build/index.js

# å†æ¬¡æŸ¥çœ‹å·¥å…·åˆ—è¡¨
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}' | node build/index.js

# åˆ‡æ¢åˆ°adminè§’è‰²
echo '{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"switch_role","arguments":{"role":"admin"}}}' | node build/index.js

# æŸ¥çœ‹æ‰€æœ‰å·¥å…·
echo '{"jsonrpc":"2.0","id":4,"method":"tools/list","params":{}}' | node build/index.js
```

### 2. ä½¿ç”¨Tokenæµ‹è¯•æƒé™

```bash
# 1. åˆ›å»ºTokenï¼ˆéœ€è¦adminè§’è‰²ï¼‰
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"token_create","arguments":{"role":"analyst","description":"æµ‹è¯•Token","expiresIn":"2h"}}}' | node build/index.js

# 2. ä½¿ç”¨Tokenè·å–å·¥å…·åˆ—è¡¨
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{"_meta":{"token":"your-token"}}}' | node build/index.js

# 3. éªŒè¯Token
echo '{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"validate_token","arguments":{"token":"your-token"}}}' | node build/index.js

# 4. è·å–Tokenè§’è‰²ä¿¡æ¯
echo '{"jsonrpc":"2.0","id":4,"method":"tools/call","params":{"name":"get_token_role_info","arguments":{"token":"your-token"}}}' | node build/index.js
```

### 3. æƒé™æŠ¥å‘Šè°ƒè¯•

```typescript
// åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æŸ¥çœ‹æƒé™
const report = container.getPermissionReport('user');
console.log(report);

// è¾“å‡ºç¤ºä¾‹ï¼š
// å®¹å™¨: åŸºç¡€å·¥å…·é›† (basic)
// è§’è‰²: user - æ™®é€šç”¨æˆ·
// å…è®¸çš„ç»„: public, basic
// å¯è§å·¥å…· (2/2):
//   âœ“ echo [public, basic]
//   âœ“ add [public, basic]
```

## ğŸ“‹ æƒé™é…ç½®æœ€ä½³å®è·µ

### 1. æœ€å°æƒé™åŸåˆ™
```typescript
// âœ… å¥½ï¼šåªåˆ†é…å¿…è¦çš„ç»„
export const dataFilter: Tool = {
  groups: ['data-group']  // åªéœ€è¦æ•°æ®å¤„ç†æƒé™
};

// âŒ åï¼šè¿‡åº¦æˆæƒ
export const dataFilter: Tool = {
  groups: ['data-group', 'sensitive', 'admin-only']  // æƒé™è¿‡å¤§
};
```

### 2. åŠŸèƒ½ç›¸å…³æ€§
```typescript
// âœ… å¥½ï¼šç›¸å…³åŠŸèƒ½åˆ†é…ç›¸åŒç»„
export const fileRead: Tool = { groups: ['file-io', 'public'] };
export const fileWrite: Tool = { groups: ['file-io', 'public'] };
export const fileSearch: Tool = { groups: ['file-io', 'public'] };

// âŒ åï¼šç›¸å…³åŠŸèƒ½åˆ†é…ä¸åŒç»„
export const fileRead: Tool = { groups: ['public'] };
export const fileWrite: Tool = { groups: ['file-io'] };
```

### 3. å®‰å…¨è€ƒè™‘
```typescript
// âœ… å¥½ï¼šæ•æ„Ÿæ“ä½œä½¿ç”¨ç‹¬ç«‹ç»„
export const deleteData: Tool = {
  groups: ['data-group', 'sensitive']
};

// âœ… å¥½ï¼šç®¡ç†å‘˜ä¸“ç”¨æ“ä½œ
export const systemConfig: Tool = {
  groups: ['admin-only']
};
```

## ğŸ¯ æƒé™é—®é¢˜æ’æŸ¥æ¸…å•

å½“é‡åˆ°æƒé™é—®é¢˜æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **å·¥å…·æ˜¯å¦åˆ†é…groupsæ ‡ç­¾ï¼Ÿ**
   ```typescript
   console.log(tool.groups); // åº”è¯¥ä¸ä¸ºç©º
   ```

2. **è§’è‰²çš„allowedGroupsæ˜¯å¦åŒ…å«å·¥å…·çš„groupsï¼Ÿ**
   ```typescript
   const role = config.roles['user'];
   const hasPermission = role.allowedGroups.some(g => tool.groups.includes(g));
   ```

3. **å·¥å…·æ˜¯å¦æ³¨å†Œåˆ°æ­£ç¡®å®¹å™¨ï¼Ÿ**
   ```typescript
   console.log(container.hasRaw('tool_name')); // true/false
   ```

4. **å½“å‰è§’è‰²æ˜¯å¦æ­£ç¡®ï¼Ÿ**
   ```typescript
   console.log(currentUserRole); // 'user', 'analyst', 'admin'
   ```

5. **Tokenæ˜¯å¦æœ‰æ•ˆï¼Ÿ**
   ```typescript
   const role = globalTokenManager.validateToken(token);
   console.log(role); // åº”è¯¥è¿”å›è§’è‰²åæˆ–null
   ```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å·¥å…·å¼€å‘**ï¼š[01_å·¥å…·å¼€å‘åŸºç¡€.md](01_å·¥å…·å¼€å‘åŸºç¡€.md)
- **æ¡†æ¶æ¶æ„**ï¼š[03_æ¡†æ¶æ¶æ„æ ¸å¿ƒ.md](03_æ¡†æ¶æ¶æ„æ ¸å¿ƒ.md)
- **Tokenç³»ç»Ÿ**ï¼š[05_Tokenç®¡ç†ç³»ç»Ÿ.md](05_Tokenç®¡ç†ç³»ç»Ÿ.md)

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [03_æ¡†æ¶æ¶æ„æ ¸å¿ƒ.md](03_æ¡†æ¶æ¶æ„æ ¸å¿ƒ.md)