# æƒé™ç®¡ç†ç³»ç»Ÿæ¶æ„è¯´æ˜

## ğŸ“‹ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Tools)                           â”‚
â”‚  token-management.ts  |  token-based-tool-fetcher.ts       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MCPæœåŠ¡å™¨å±‚ (Server)                        â”‚
â”‚  wrappedExecute() |  get_all_visible_tools()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç»Ÿä¸€æƒé™ç®¡ç†å™¨ (PermissionManager)              â”‚
â”‚  æƒé™æ£€æŸ¥ | å·¥å…·è¿‡æ»¤ | é”™è¯¯å¤„ç† | é…ç½®ç®¡ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tokenç®¡ç†ç³»ç»Ÿ (TokenManager)               â”‚
â”‚  validateTokenDetailed() â†’ TokenValidationResult            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— å…³è”å…³ç³»è¯¦è§£

### 1. **Tokenç®¡ç†ç³»ç»Ÿ â†’ æƒé™ç®¡ç†ç³»ç»Ÿ**

**TokenManagerè´Ÿè´£ï¼š**
```typescript
// 1. Tokençš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
createToken(role, description, expiresIn)  // åˆ›å»º
validateToken(token)                       // éªŒè¯  
getTokenInfo(token)                        // æŸ¥è¯¢
deleteToken(token)                         // åˆ é™¤

// 2. æä¾›ç»Ÿä¸€éªŒè¯æ¥å£ï¼ˆæ–°å¢ï¼‰
validateTokenDetailed(token): TokenValidationResult
```

**TokenValidationResultç»“æ„ï¼š**
```typescript
{
  isValid: boolean;      // Tokenæ˜¯å¦æœ‰æ•ˆ
  role: string | null;   // ç”¨æˆ·è§’è‰²
  tokenInfo: TokenInfo | null;  // Tokenè¯¦ç»†ä¿¡æ¯
  error?: string;        // é”™è¯¯ä¿¡æ¯
}
```

### 2. **æƒé™ç®¡ç†ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨TokenManager**

**PermissionManagerä¾èµ–TokenManagerï¼š**
```typescript
// åœ¨MCPæœåŠ¡å™¨ä¸­
const validationResult = globalTokenManager.validateTokenDetailed(token);
const permissionCheck = globalPermissionManager.validateToolAccess(
  validationResult,
  tool.groups || []
);
```

**å·¥ä½œæµç¨‹ï¼š**
1. **TokenéªŒè¯** â†’ TokenManager.validateTokenDetailed()
2. **æƒé™æ£€æŸ¥** â†’ PermissionManager.validateToolAccess()
3. **ç»“æœè¿”å›** â†’ å…è®¸/æ‹’ç» + é”™è¯¯ä¿¡æ¯

### 3. **åˆ†å±‚èŒè´£åˆ’åˆ†**

#### **TokenManagerå±‚ï¼ˆæ•°æ®å±‚ï¼‰**
- âœ… ç®¡ç†tokençš„å­˜å‚¨å’Œç”Ÿå‘½å‘¨æœŸ
- âœ… éªŒè¯tokençš„æœ‰æ•ˆæ€§
- âœ… æä¾›tokenè¯¦ç»†ä¿¡æ¯
- âŒ **ä¸å…³å¿ƒ**æƒé™é€»è¾‘

#### **PermissionManagerå±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰**
- âœ… å®šä¹‰æƒé™è§„åˆ™
- âœ… æ£€æŸ¥è§’è‰²æƒé™
- âœ… è¿‡æ»¤å¯è§å·¥å…·
- âœ… ç”Ÿæˆé”™è¯¯ä¿¡æ¯
- âŒ **ä¸å…³å¿ƒ**tokenå­˜å‚¨

#### **MCPæœåŠ¡å™¨å±‚ï¼ˆåº”ç”¨å±‚ï¼‰**
- âœ… è°ƒç”¨TokenManageréªŒè¯token
- âœ… è°ƒç”¨PermissionManageræ£€æŸ¥æƒé™
- âœ… æ‰§è¡Œå·¥å…·æˆ–è¿”å›é”™è¯¯
- âŒ **ä¸å…³å¿ƒ**å…·ä½“éªŒè¯å’Œæ£€æŸ¥é€»è¾‘

## ğŸ”„ å®Œæ•´è°ƒç”¨é“¾è·¯ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è°ƒç”¨ `token_create` å·¥å…·

```
ç”¨æˆ·è¯·æ±‚
  â†“
MCPæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚
  â†“
è·å–token: args.token
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: TokenéªŒè¯                      â”‚
â”‚  globalTokenManager.validateTokenDetailed(token) â”‚
â”‚  â†’ è¿”å›: { isValid: true, role: 'user' } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: æƒé™æ£€æŸ¥                       â”‚
â”‚  globalPermissionManager.validateToolAccess() â”‚
â”‚  â†’ æ£€æŸ¥: useræ˜¯å¦æœ‰æƒè®¿é—®admin-onlyå·¥å…· â”‚
â”‚  â†’ è¿”å›: { allowed: false, error: "æƒé™ä¸è¶³" } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è¿”å›é”™è¯¯å“åº”
```

### åœºæ™¯ï¼šç”¨æˆ·è°ƒç”¨ `add` å·¥å…·

```
ç”¨æˆ·è¯·æ±‚
  â†“
MCPæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚
  â†“
è·å–token: args.token
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: TokenéªŒè¯                      â”‚
â”‚  globalTokenManager.validateTokenDetailed(token) â”‚
â”‚  â†’ è¿”å›: { isValid: true, role: 'user' } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: æƒé™æ£€æŸ¥                       â”‚
â”‚  globalPermissionManager.validateToolAccess() â”‚
â”‚  â†’ æ£€æŸ¥: useræ˜¯å¦æœ‰æƒè®¿é—®publicå·¥å…·     â”‚
â”‚  â†’ è¿”å›: { allowed: true }               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
æ‰§è¡Œå·¥å…·é€»è¾‘
  â†“
è¿”å›ç»“æœ
```

## ğŸ¯ å…³é”®å…³è”ç‚¹

### 1. **æ•°æ®ä¼ é€’**
```typescript
// TokenManageræä¾›æ•°æ®
const tokenValidation = globalTokenManager.validateTokenDetailed(token);

// PermissionManagerä½¿ç”¨æ•°æ®
const permissionCheck = globalPermissionManager.validateToolAccess(
  tokenValidation,  // â† ä¾èµ–TokenManagerçš„è¾“å‡º
  tool.groups
);
```

### 2. **é”™è¯¯å¤„ç†åä½œ**
```typescript
// TokenManagerå‘ç°tokenæ— æ•ˆ
if (!tokenValidation.isValid) {
  return { allowed: false, reason: tokenValidation.error };
}

// PermissionManagerå‘ç°æƒé™ä¸è¶³
if (!permissionCheck.allowed) {
  return { allowed: false, reason: permissionCheck.error };
}
```

### 3. **é…ç½®åˆ†ç¦»**
```typescript
// TokenManageré…ç½®ï¼štokenå­˜å‚¨ã€è¿‡æœŸæ—¶é—´ç­‰
// PermissionManageré…ç½®ï¼šè§’è‰²æƒé™æ˜ å°„ã€åˆ†ç»„è§„åˆ™ç­‰
```

## ğŸ“¦ æ¨¡å—ä¾èµ–å…³ç³»

```typescript
// permission-manager.ts
import { TokenValidationResult } from './token-manager.js';

// mcp-server.ts  
import { globalTokenManager } from './core/token/token-manager.js';
import { globalPermissionManager } from './core/token/permission-manager.js';

// å·¥å…·æ–‡ä»¶ï¼ˆä¸éœ€è¦ä¿®æ”¹ï¼‰
import { globalTokenManager } from '../core/token/token-manager.js';
```

## ğŸš€ æ‰©å±•æ€§è¯´æ˜

### æ·»åŠ æ–°è§’è‰²çš„å®Œæ•´æµç¨‹ï¼š

**1. TokenManagerå±‚é¢ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰**
```typescript
// å·²æœ‰åŠŸèƒ½ï¼Œè‡ªåŠ¨æ”¯æŒæ–°è§’è‰²
const token = globalTokenManager.createToken('security', 'å®‰å…¨ä¸“å®¶');
const validation = globalTokenManager.validateTokenDetailed(token);
// validation.role = 'security' âœ…
```

**2. PermissionManagerå±‚é¢ï¼ˆéœ€è¦é…ç½®ï¼‰**
```typescript
// æ·»åŠ æƒé™é…ç½®
globalPermissionManager.registerPermissionGroup('security-management', ['security', 'admin']);
```

**3. MCPæœåŠ¡å™¨å±‚é¢ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰**
```typescript
// è‡ªåŠ¨ä½¿ç”¨æ–°çš„æƒé™é…ç½®
const check = globalPermissionManager.validateToolAccess(validation, tool.groups);
```

**4. å·¥å…·å±‚é¢ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰**
```typescript
// å·¥å…·å®šä¹‰ä¿æŒä¸å˜
export const securityTool: Tool = {
  name: 'security_audit',
  groups: ['security-management'],
  // ...
};
```

## ğŸ’¡ è®¾è®¡ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**ï¼šTokenç®¡ç† vs æƒé™é€»è¾‘
2. **æ•°æ®é©±åŠ¨**ï¼šTokenManageræä¾›æ•°æ®ï¼ŒPermissionManageråšå†³ç­–
3. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢è§’è‰²åªéœ€é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
4. **æµ‹è¯•å‹å¥½**ï¼šå„å±‚å¯ç‹¬ç«‹æµ‹è¯•
5. **ç»´æŠ¤ç®€å•**ï¼šé€»è¾‘é›†ä¸­ï¼Œé—®é¢˜å®šä½å¿«é€Ÿ

## ğŸ”§ è°ƒè¯•å»ºè®®

**æŸ¥çœ‹tokenä¿¡æ¯ï¼š**
```typescript
const info = globalTokenManager.validateTokenDetailed(token);
console.log(info); // { isValid, role, tokenInfo, error }
```

**æŸ¥çœ‹æƒé™é…ç½®ï¼š**
```typescript
const perms = globalPermissionManager.getRolePermissions('user');
console.log(perms); // { role, level, canAccess, cannotAccess }
```

**æŸ¥çœ‹å·¥å…·æƒé™ï¼š**
```typescript
const check = globalPermissionManager.checkTokenPermission(validation, ['admin-only']);
console.log(check); // { allowed, reason }