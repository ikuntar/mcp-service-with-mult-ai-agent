# å¼‚æ­¥é˜Ÿåˆ—ä¸æ¶ˆæ¯é˜Ÿåˆ—

## ğŸ¯ æ¶æ„æ¦‚è¿°

ä¸ºç”¨æˆ·ç©ºé—´æ·»åŠ äº†åŸºäºå¯¹è±¡çš„å¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—å’Œæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨äºæ”¯æŒå¼‚æ­¥MCPå·¥å…·è°ƒç”¨å’Œæ¶ˆæ¯ä¼ é€’ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- **å¼‚æ­¥æ”¯æŒ**ï¼šç”¨æˆ·æ„ŸçŸ¥å¼‚æ­¥ï¼Œåº•å±‚é˜»å¡å¼è°ƒç”¨
- **å®Œæ•´æ•°æ®**ï¼šä¿ç•™æ‰€æœ‰åŸå§‹è°ƒç”¨ä¿¡æ¯
- **ç”¨æˆ·éš”ç¦»**ï¼šå¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨
- **ç®€åŒ–ä½¿ç”¨**ï¼šæ— éœ€é¢„å…ˆæ³¨å†Œå·¥å…·ï¼Œä¸€æ­¥å®Œæˆä»»åŠ¡æäº¤

## ğŸ—ï¸ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. è®¿é—®æ§åˆ¶
- âŒ **ç”¨æˆ·ä¸èƒ½ç›´æ¥è®¿é—®**ï¼šå¼‚æ­¥é˜Ÿåˆ—å’Œæ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ–¹æ³•
- âœ… **ä»…å¯¹ç‰¹å®šMCPå·¥å…·å¼€æ”¾**ï¼šé€šè¿‡ä¸“é—¨çš„MCPå·¥å…·æ¥å£è®¿é—®
- âœ… **ç”¨æˆ·ç©ºé—´éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„å¼‚æ­¥é˜Ÿåˆ—å®ä¾‹

### 2. æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡
- âŒ **ä¸æ”¯æŒè®¢é˜…/è®¢é˜…**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸èƒ½è¢«è®¢é˜…å’Œè®¢é˜…å…¶ä»–é˜Ÿåˆ—
- âœ… **è¯·æ±‚-å“åº”æ¨¡å¼**ï¼šæ”¯æŒæ¶ˆæ¯å‘å¸ƒã€æ¥æ”¶å’Œå›å¤
- âœ… **ç”¨æˆ·ç©ºé—´éš¶å±**ï¼šæ¶ˆæ¯é˜Ÿåˆ—éš¶å±äºç”¨æˆ·ç©ºé—´ï¼Œæä¾›ç”¨æˆ·éš”ç¦»

### 3. æƒè´£å…³ç³»
- **å¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—**ï¼šéš¶å±äºç”¨æˆ·ç©ºé—´ï¼Œæä¾›å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œèƒ½åŠ›
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šéš¶å±äºç”¨æˆ·ç©ºé—´ï¼Œæä¾›ç”¨æˆ·ç©ºé—´å†…çš„æ¶ˆæ¯ä¼ é€’
- **MCPå·¥å…·**ï¼šä½œä¸ºå”¯ä¸€çš„è®¿é—®å…¥å£ï¼Œç¡®ä¿æƒé™æ§åˆ¶

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### ä¼˜åŒ–å‰åå¯¹æ¯”

**âŒ åŸæ¶æ„ï¼ˆä¸¤æ­¥æµç¨‹ï¼‰**ï¼š
```typescript
// 1. æ³¨å†Œå·¥å…·ï¼ˆå†—ä½™ï¼‰
userSpace.asyncTaskExecutor.registerTool(myTool);

// 2. æäº¤ä»»åŠ¡
const task = userSpace.asyncTaskExecutor.submitTask(
  token, 'my_tool', { param: 'value' }
);
```

**âœ… ä¼˜åŒ–æ¶æ„ï¼ˆä¸€æ­¥å®Œæˆï¼‰**ï¼š
```typescript
// ç›´æ¥æäº¤ï¼ˆå·¥å…·å·²å­˜åœ¨äºå®¹å™¨ä¸­ï¼‰
const task = userSpace.asyncTaskExecutor.submitTask(
  token, 'my_tool', { param: 'value' }
);
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨ (OptimizedAsyncTaskExecutor)

**æ–‡ä»¶**: `src/core/async-task-executor-optimized.ts`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… **æ— éœ€é¢„å…ˆæ³¨å†Œå·¥å…·** - ç›´æ¥ä½¿ç”¨å·¥å…·å®¹å™¨ä¸­çš„å·¥å…·
- âœ… **å®Œæ•´åŸå§‹è°ƒç”¨å­˜å‚¨** - é€šè¿‡ `OriginalCallData` æ¥å£å­˜å‚¨å®Œæ•´ä¿¡æ¯
- âœ… **ä¸°å¯Œè¿”å›ä¿¡æ¯** - è¿”å›å®Œæ•´çš„ `AsyncTask` å¯¹è±¡
- âœ… **æ˜ç¡®ç”¨æˆ·Token** - æ‰€æœ‰æ•°æ®ç»“æ„ä¸­æ˜ç¡®æ ‡è¯†ç”¨æˆ·èº«ä»½
- âœ… **æ”¯æŒæŸ¥çœ‹åŸå§‹è°ƒç”¨** - æ–°å¢ `getTaskOriginalCall()` æ–¹æ³•

**å…³é”®æ¥å£**ï¼š
```typescript
interface OriginalCallData {
  token: string;           // ç”¨æˆ·Token
  toolName: string;        // å·¥å…·åç§°
  toolArgs: any;           // å·¥å…·å‚æ•°
  metadata?: Record<string, any>;
  timestamp: string;
  requestId?: string;
}

interface AsyncTask {
  id: string;
  token: string;
  toolName: string;
  toolArgs: any;
  status: AsyncTaskStatus;  // 'pending' | 'running' | 'completed' | 'failed' | 'cancelled'
  createdAt: string;
  result?: ToolResult;
  error?: string;
  originalCall: OriginalCallData;  // âœ… å®Œæ•´åŸå§‹è°ƒç”¨æ•°æ®
  executionTime?: number;
}
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
class OptimizedAsyncTaskExecutor {
  submitTask(token: string, toolName: string, toolArgs: any, metadata?: Record<string, any>, requestId?: string): AsyncTask
  getTask(taskId: string): AsyncTask | undefined
  getTaskOriginalCall(taskId: string): OriginalCallData | undefined
  waitForTask(taskId: string, timeout?: number): Promise<AsyncTask>
  cancelTask(taskId: string): boolean
  deleteTask(taskId: string): boolean
  getUserTasks(token: string): AsyncTask[]
  getStats(token?: string): { total: number; byStatus: Record<string, number> }
}
```

### 2. æ¶ˆæ¯é˜Ÿåˆ— (MessageQueue)

**æ–‡ä»¶**: `src/core/message-queue.ts`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… **ç”¨æˆ·å…¨æƒå¤„ç†** - å®Œå…¨æ§åˆ¶æ¶ˆæ¯ä¼ é€’
- âœ… **è¯·æ±‚-å“åº”æ¨¡å¼** - æ”¯æŒæ¶ˆæ¯å›å¤
- âœ… **ç”¨æˆ·éš”ç¦»** - å¤šç”¨æˆ·ç¯å¢ƒå®‰å…¨
- âœ… **ä¼˜å…ˆçº§ç®¡ç†** - æ¶ˆæ¯ä¼˜å…ˆçº§æ’åº
- âœ… **è¿‡æœŸç®¡ç†** - æ¶ˆæ¯TTLæ”¯æŒ

**å…³é”®æ¥å£**ï¼š
```typescript
interface Message {
  id: string;
  type: MessageType;  // 'tool-request' | 'tool-response' | 'notification' | 'event' | 'error'
  priority: MessagePriority;  // 'low' | 'normal' | 'high' | 'critical'
  source: string;
  destination: string;
  content: any;
  timestamp: string;
  ttl?: number;
  metadata?: Record<string, any>;
  responseTo?: string;
}
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
class MessageQueue {
  publish(type: MessageType, source: string, destination: string, content: any, priority?: MessagePriority, ttl?: number, metadata?: Record<string, any>, responseTo?: string): Message
  reply(originalMessage: Message, source: string, content: any, priority?: MessagePriority, ttl?: number, metadata?: Record<string, any>): Message
  receiveMessage(destination: string, filter?: (msg: Message) => boolean): Message | null
  getPendingMessages(destination: string): Message[]
  getStats(destination?: string): { total: number; pending: number; byType: Record<string, number>; byPriority: Record<string, number> }
  cleanupUserMessages(user: string): number
}
```

### 3. ç”¨æˆ·ç©ºé—´é›†æˆ

**æ–‡ä»¶**: `src/core/user-space-optimized.ts`

```typescript
interface UserSpace {
  token: string;
  role: string;
  asyncTaskExecutor: OptimizedAsyncTaskExecutor;  // âœ… ä¼˜åŒ–ç‰ˆ
  messageQueue: MessageQueue;
  toolContainer?: EnhancedToolContainer;
  // ... å…¶ä»–å±æ€§
}
```

## ğŸ› ï¸ MCPå·¥å…·é›†ï¼ˆ15ä¸ªï¼‰

### å¼‚æ­¥ä»»åŠ¡ç®¡ç† (9ä¸ª)
1. `register_async_task` - æ³¨å†Œå·¥å…·ï¼ˆå¯é€‰ï¼‰
2. `submit_async_task` - æäº¤ä»»åŠ¡ï¼ˆè¿”å›å®Œæ•´ä¿¡æ¯ï¼‰
3. `get_async_task_status` - æŸ¥è¯¢çŠ¶æ€
4. `get_task_original_call` - âœ… **æ–°å¢** æŸ¥çœ‹åŸå§‹è°ƒç”¨
5. `wait_async_task` - ç­‰å¾…å®Œæˆ
6. `get_user_async_tasks` - è·å–ç”¨æˆ·ä»»åŠ¡
7. `get_async_task_stats` - ç»Ÿè®¡ä¿¡æ¯
8. `cancel_async_task` - å–æ¶ˆä»»åŠ¡
9. `delete_async_task` - åˆ é™¤ä»»åŠ¡

### æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç† (6ä¸ª)
1. `publish_message` - å‘å¸ƒæ¶ˆæ¯
2. `receive_message` - æ¥æ”¶æ¶ˆæ¯
3. `reply_message` - å›å¤æ¶ˆæ¯
4. `get_pending_messages` - æŸ¥çœ‹å¾…å¤„ç†
5. `get_message_queue_stats` - ç»Ÿè®¡ä¿¡æ¯
6. `cleanup_expired_messages` - æ¸…ç†è¿‡æœŸ

## ğŸ’¡ å…³é”®æ”¹è¿›

### 1. è§£å†³ä¸Šä¸‹æ–‡ä¸¢å¤±
```typescript
// å­˜å‚¨å®Œæ•´çš„åŸå§‹è°ƒç”¨æ•°æ®
const originalCall: OriginalCallData = {
  token, toolName, toolArgs, metadata, timestamp, requestId
};

// ä»»åŠ¡å¯¹è±¡ä¸­ä¿ç•™
const task: AsyncTask = {
  // ...
  originalCall  // âœ… å®Œæ•´æ•°æ®
};
```

### 2. ä¸°å¯Œè¿”å›ä¿¡æ¯
```typescript
const task = executor.submitTask(token, toolName, args);
// è¿”å›åŒ…å«ï¼š
// - task.id, task.token, task.toolName, task.toolArgs
// - task.status, task.createdAt
// - task.originalCall (å®Œæ•´åŸå§‹æ•°æ®)
// - task.executionTime, task.result (å®Œæˆå)
```

### 3. æ˜ç¡®ç”¨æˆ·æ ‡è¯†
- `OriginalCallData.token` - æ˜ç¡®æ ‡è¯†
- `AsyncTask.token` - æ˜ç¡®æ ‡è¯†
- `Message.source/destination` - æ˜ç¡®æ ‡è¯†

### 4. æ”¯æŒæŸ¥çœ‹åŸå§‹è°ƒç”¨
```typescript
const original = userSpace.asyncTaskExecutor.getTaskOriginalCall(taskId);
// è¿”å›å®Œæ•´çš„ OriginalCallData
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ
```typescript
// 1. åˆ›å»ºç”¨æˆ·ç©ºé—´
const token = globalTokenManager.createToken('user', 'ç”¨æˆ·');
const container = new EnhancedToolContainer('å·¥å…·é›†', 'test', config);
container.register(myTool);

const userSpace = globalOptimizedUserSpaceManager.getUserSpace(token, 'user', container);

// 2. ç›´æ¥æäº¤ä»»åŠ¡ï¼ˆæ— éœ€æ³¨å†Œï¼‰
const task = userSpace.asyncTaskExecutor.submitTask(
  token, 'my_tool', { param: 'value' }, { priority: 'high' }, 'request-123'
);

// 3. ç­‰å¾…å®Œæˆ
const completed = await userSpace.asyncTaskExecutor.waitForTask(task.id);

// 4. æŸ¥çœ‹åŸå§‹è°ƒç”¨
const original = userSpace.asyncTaskExecutor.getTaskOriginalCall(task.id);
```

### æ¶ˆæ¯é˜Ÿåˆ—
```typescript
// å‘å¸ƒæ¶ˆæ¯
const msg = globalMessageQueue.publish(
  'notification', token, targetToken, { data: 'value' }, 'high'
);

// æ¥æ”¶æ¶ˆæ¯
const received = globalMessageQueue.receiveMessage(token);

// å›å¤æ¶ˆæ¯
const reply = globalMessageQueue.reply(received, token, { response: 'ok' });
```

## ğŸ” ç”¨æˆ·éš”ç¦»

### å¼‚æ­¥ä»»åŠ¡éš”ç¦»
- æ¯ä¸ªç”¨æˆ·ç©ºé—´ç‹¬ç«‹çš„ `AsyncTaskExecutor`
- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä»»åŠ¡
- é€šè¿‡ `token` æ ‡è¯†æ‰€æœ‰æƒ

### æ¶ˆæ¯é˜Ÿåˆ—éš”ç¦»
- å…±äº« `MessageQueue` å®ä¾‹
- é€šè¿‡ `destination` å­—æ®µéš”ç¦»
- ç”¨æˆ·åªèƒ½æ¥æ”¶è‡ªå·±çš„æ¶ˆæ¯

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

1. **TokenéªŒè¯**: æ‰€æœ‰æ“ä½œå‰éªŒè¯Token
2. **æ‰€æœ‰æƒæ£€æŸ¥**: éªŒè¯ä»»åŠ¡/æ¶ˆæ¯æ‰€æœ‰æƒ
3. **æƒé™æ§åˆ¶**: MCPå·¥å…·å±‚æƒé™ç®¡ç†
4. **æ•°æ®éš”ç¦»**: ç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»

## âš¡ æ€§èƒ½ç‰¹ç‚¹

- **å¼‚æ­¥æ„ŸçŸ¥**: ç”¨æˆ·æ„ŸçŸ¥å¼‚æ­¥ï¼Œåº•å±‚é˜»å¡è°ƒç”¨
- **å†…å­˜å­˜å‚¨**: ä»»åŠ¡å’Œæ¶ˆæ¯å­˜å‚¨åœ¨å†…å­˜
- **æŒä¹…æ€§**: é€šè¿‡ä»»åŠ¡IDå’ŒTokenç®¡ç†
- **å¯æ‰©å±•**: æ”¯æŒå¤šç”¨æˆ·å¹¶å‘

## ğŸ“Š ä¾èµ–å…³ç³»

**æ ¸å¿ƒç»„ä»¶ä¾èµ–**ï¼š
```
OptimizedAsyncTaskExecutor
â”œâ”€ Toolç±»å‹ (1ä¸ªä¾èµ–)
â””â”€ ToolProvideræ¥å£ (1ä¸ªä¾èµ–)
   â””â”€ UserSpaceToolProvider
      â”œâ”€ EnhancedToolContainer
      â””â”€ UserSpaceä¿¡æ¯
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ ¸å¿ƒç»„ä»¶ä»…2ä¸ªä¾èµ–ï¼Œæåº¦ç®€æ´
- âœ… é€šè¿‡æ¥å£å®Œå…¨è§£è€¦
- âœ… æ— å¾ªç¯ä¾èµ–
- âœ… æ˜“äºæµ‹è¯•å’Œæ‰©å±•

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### æ¶æ„ç®€åŒ–
- **ä»ä¸¤æ­¥åˆ°ä¸€æ­¥** - æ¶ˆé™¤å†—ä½™æ³¨å†Œæ­¥éª¤
- **åŠŸèƒ½é›†æˆ** - å¼‚æ­¥ä»»åŠ¡å’Œæ¶ˆæ¯é˜Ÿåˆ—ç»Ÿä¸€ç®¡ç†

### åŠŸèƒ½å¼ºå¤§
- **å®Œæ•´æ•°æ®ä¿ç•™** - æ‰€æœ‰åŸå§‹è°ƒç”¨ä¿¡æ¯å®Œæ•´ä¿å­˜
- **ç”¨æˆ·éš”ç¦»** - å¤šç”¨æˆ·ç¯å¢ƒå®‰å…¨å¯é 

### æ˜“äºä½¿ç”¨
- **ä¸€æ­¥å®Œæˆ** - æ— éœ€é¢„å…ˆæ³¨å†Œå·¥å…·
- **ä¸°å¯Œè¿”å›** - æä¾›å®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†…å­˜å­˜å‚¨** - ä»»åŠ¡å’Œæ¶ˆæ¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œé‡å¯åä¸¢å¤±
2. **å¼‚æ­¥æ„ŸçŸ¥** - ç”¨æˆ·æ„ŸçŸ¥å¼‚æ­¥ï¼Œä½†åº•å±‚æ˜¯é˜»å¡è°ƒç”¨
3. **å·¥å…·å®¹å™¨** - éœ€è¦æä¾›å·¥å…·å®¹å™¨æˆ–å·¥å…·æä¾›è€…
4. **Tokenç®¡ç†** - éœ€è¦æœ‰æ•ˆçš„Tokenè¿›è¡Œç”¨æˆ·éš”ç¦»
5. **ä¸æ”¯æŒè®¢é˜…** - æ¶ˆæ¯é˜Ÿåˆ—é‡‡ç”¨è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œä¸æ”¯æŒè®¢é˜…/è®¢é˜…

---

**æ€»ç»“**ï¼šå¼‚æ­¥é˜Ÿåˆ—ä¸æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„ä¸ºç”¨æˆ·ç©ºé—´æä¾›äº†å®Œæ•´çš„å¼‚æ­¥ä»»åŠ¡å¤„ç†å’Œæ¶ˆæ¯ä¼ é€’èƒ½åŠ›ï¼Œè§£å†³äº†ä¸Šä¸‹æ–‡ä¸¢å¤±ã€è¿”å›ä¿¡æ¯ä¸è¶³ã€ç”¨æˆ·æ ‡è¯†ä¸æ˜ç¡®ç­‰å…³é”®é—®é¢˜ï¼ŒåŒæ—¶é€šè¿‡ä¼˜åŒ–æ¶ˆé™¤äº†"å…ˆæ³¨å†Œåè°ƒç”¨"çš„å†—ä½™ã€‚