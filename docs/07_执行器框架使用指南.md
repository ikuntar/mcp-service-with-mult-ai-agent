# 07_æ‰§è¡Œå™¨æ¡†æ¶ä½¿ç”¨æŒ‡å—

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£æ‰§è¡Œå™¨æ¡†æ¶å·¥ä½œåŸç†
- æŒæ¡æ‰§è¡Œå™¨ç±»å‹é€‰æ‹©
- å­¦ä¼šè‡ªå®šä¹‰æ‰§è¡Œå™¨

## ğŸ—ï¸ æ‰§è¡Œå™¨æ¡†æ¶æ¦‚è¿°

æ‰§è¡Œå™¨æ¡†æ¶æ˜¯æƒé™æ§åˆ¶çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ï¼š

```
å·¥å…·å®šä¹‰ â†’ æ‰§è¡Œå™¨é€‰æ‹© â†’ è§„åˆ™æ£€æŸ¥ â†’ å®é™…æ‰§è¡Œ â†’ è¿”å›ç»“æœ
```

### æ ¸å¿ƒç»„ä»¶

#### 1. UnifiedExecutorLayerï¼ˆç»Ÿä¸€æ‰§è¡Œå™¨å±‚ï¼‰
```typescript
class UnifiedExecutorLayer {
  constructor(dataPath: string)
  
  // æ‰§è¡Œå·¥å…·
  async executeTool(tool: Tool, args: any, token: string): Promise<ToolResult>
  
  // è·å–è§„åˆ™ç®¡ç†å™¨
  getRuleManager(): TokenRuleManager
  
  // è·å–æ‰§è¡Œå™¨å·¥å‚
  getExecutorFactory(): ExecutorFactory
}
```

#### 2. ExecutorFactoryï¼ˆæ‰§è¡Œå™¨å·¥å‚ï¼‰
```typescript
class ExecutorFactory {
  // æ³¨å†Œæ‰§è¡Œå™¨ç±»å‹
  register(type: string, factory: IExecutorFactory): void
  
  // åˆ›å»ºæ‰§è¡Œå™¨å®ä¾‹
  async create(tool: Tool, token: string): Promise<ExecutorInstance>
  
  // è·å–æ‰§è¡Œå™¨ç±»å‹
  getExecutorType(tool: Tool): string
}
```

## âš™ï¸ æ‰§è¡Œå™¨ç±»å‹

### 1. DefaultExecutorï¼ˆé»˜è®¤æ‰§è¡Œå™¨ï¼‰
- **ç”¨é€”**: é€šç”¨å·¥å…·æ‰§è¡Œ
- **å·¥å…·å‰ç¼€**: æ— ç‰¹å®šå‰ç¼€
- **è§„åˆ™**: autoApprove, maxCalls
- **é€‚ç”¨åœºæ™¯**: å¤§å¤šæ•°æ™®é€šå·¥å…·

```typescript
const simpleTool: Tool = {
  name: 'echo',
  description: 'ç®€å•å›å£°å·¥å…·',
  groups: ['public', 'basic'],
  inputSchema: {
    type: 'object',
    properties: { message: { type: 'string' } }
  },
  execute: async (args) => ({
    content: [{ type: 'text', text: args.message }]
  })
};
// è‡ªåŠ¨ä½¿ç”¨ DefaultExecutor
```

### 2. FileSystemExecutorï¼ˆæ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œå™¨ï¼‰
- **ç”¨é€”**: æ–‡ä»¶æ“ä½œ
- **å·¥å…·å‰ç¼€**: `file_`
- **è§„åˆ™**: autoApprove, maxFileSize, maxCalls
- **é€‚ç”¨åœºæ™¯**: æ–‡ä»¶è¯»å†™ã€åˆ é™¤ç­‰æ“ä½œ

```typescript
const fileTool: Tool = {
  name: 'file_read',
  description: 'è¯»å–æ–‡ä»¶',
  groups: ['file-io', 'public'],
  executor: { type: 'filesystem' },  // æ˜¾å¼å£°æ˜
  inputSchema: {
    type: 'object',
    properties: { path: { type: 'string' } }
  },
  execute: async (args) => {
    const content = await fs.readFile(args.path, 'utf-8');
    return { content: [{ type: 'text', text: content }] };
  }
};
```

### 3. NetworkExecutorï¼ˆç½‘ç»œæ‰§è¡Œå™¨ï¼‰
- **ç”¨é€”**: ç½‘ç»œè¯·æ±‚
- **å·¥å…·å‰ç¼€**: `http_`
- **è§„åˆ™**: autoApprove, timeout, allowedDomains, maxCalls
- **é€‚ç”¨åœºæ™¯**: HTTPè¯·æ±‚ã€APIè°ƒç”¨ã€ä¸‹è½½

```typescript
const httpTool: Tool = {
  name: 'http_request',
  description: 'å‘é€HTTPè¯·æ±‚',
  groups: ['network', 'advanced'],
  executor: { type: 'network' },
  inputSchema: {
    type: 'object',
    properties: {
      url: { type: 'string' },
      method: { type: 'string', enum: ['GET', 'POST'] }
    }
  },
  execute: async (args) => {
    // å®é™…HTTPè¯·æ±‚é€»è¾‘
    return { content: [{ type: 'text', text: 'å“åº”æ•°æ®' }] };
  }
};
```

### 4. SystemExecutorï¼ˆç³»ç»Ÿæ‰§è¡Œå™¨ï¼‰
- **ç”¨é€”**: ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ
- **å·¥å…·å‰ç¼€**: `exec_`
- **è§„åˆ™**: autoApprove, approver, allowedCommands, maxCalls
- **é€‚ç”¨åœºæ™¯**: æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€è„šæœ¬

```typescript
const execTool: Tool = {
  name: 'exec_command',
  description: 'æ‰§è¡Œç³»ç»Ÿå‘½ä»¤',
  groups: ['admin-only', 'sensitive'],
  executor: { type: 'system' },
  inputSchema: {
    type: 'object',
    properties: { command: { type: 'string' } }
  },
  execute: async (args) => {
    // æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
    return { content: [{ type: 'text', text: 'æ‰§è¡Œç»“æœ' }] };
  }
};
```

## ğŸ”§ æ‰§è¡Œå™¨é€‰æ‹©ç­–ç•¥

### 1. è‡ªåŠ¨æ¨æ–­è§„åˆ™

```typescript
// æ‰§è¡Œå™¨å·¥å‚çš„æ¨æ–­é€»è¾‘
getExecutorType(tool: Tool): string {
  // 1. å·¥å…·è‡ªå£°æ˜ä¼˜å…ˆ
  if (tool.executor?.type) {
    return tool.executor.type;
  }
  
  // 2. æ ¹æ®åç§°å‰ç¼€æ¨æ–­
  if (tool.name.startsWith('file_')) {
    return 'filesystem';
  }
  if (tool.name.startsWith('http_')) {
    return 'network';
  }
  if (tool.name.startsWith('exec_')) {
    return 'system';
  }
  
  // 3. é»˜è®¤æ‰§è¡Œå™¨
  return 'default';
}
```

### 2. æ‰§è¡Œå™¨é€‰æ‹©ç¤ºä¾‹

```typescript
// ç¤ºä¾‹1: æœªå£°æ˜æ‰§è¡Œå™¨çš„å·¥å…·
const tool1: Tool = {
  name: 'echo',
  groups: ['public'],
  execute: async (args) => ({ content: [{ type: 'text', text: args.message }] })
};
// â†’ ä½¿ç”¨ DefaultExecutor

// ç¤ºä¾‹2: æ ¹æ®åç§°æ¨æ–­
const tool2: Tool = {
  name: 'file_read',
  groups: ['file-io'],
  execute: async (args) => ({ content: [{ type: 'text', text: 'file' }] })
};
// â†’ ä½¿ç”¨ FileSystemExecutor

// ç¤ºä¾‹3: æ˜¾å¼å£°æ˜
const tool3: Tool = {
  name: 'custom_tool',
  groups: ['advanced'],
  executor: { type: 'network' },
  execute: async (args) => ({ content: [{ type: 'text', text: 'custom' }] })
};
// â†’ ä½¿ç”¨ NetworkExecutor
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€æ‰§è¡Œå™¨ä½¿ç”¨

```typescript
import { UnifiedExecutorLayer, ruleManagementTools } from './src/index';

// 1. åˆå§‹åŒ–æ‰§è¡Œå™¨
const executor = new UnifiedExecutorLayer('./data');

// 2. è®¾ç½®è§„åˆ™ï¼ˆå¯é€‰ï¼‰
await ruleManagementTools[0].execute({
  token: 'user_token',
  executorId: 'filesystem',
  rules: {
    autoApprove: true,
    maxFileSize: 1024 * 1024,
    maxCalls: 100
  }
});

// 3. å®šä¹‰å·¥å…·
const fileTool: Tool = {
  name: 'file_read',
  description: 'è¯»å–æ–‡ä»¶',
  groups: ['file-io', 'public'],
  inputSchema: {
    type: 'object',
    properties: { path: { type: 'string' } }
  },
  execute: async (args) => {
    const content = await fs.readFile(args.path, 'utf-8');
    return { content: [{ type: 'text', text: content }] };
  }
};

// 4. æ‰§è¡Œå·¥å…·
const result = await executor.executeTool(fileTool, { path: '/tmp/test.txt' }, 'user_token');
console.log(result);
```

### ç¤ºä¾‹2: å¤šæ‰§è¡Œå™¨åä½œ

```typescript
// å®šä¹‰ä¸åŒç±»å‹çš„å·¥å…·
const tools: Tool[] = [
  {
    name: 'echo',
    groups: ['public'],
    execute: async (args) => ({ content: [{ type: 'text', text: args.message }] })
  },
  {
    name: 'file_read',
    groups: ['file-io'],
    executor: { type: 'filesystem' },
    execute: async (args) => {
      const content = await fs.readFile(args.path, 'utf-8');
      return { content: [{ type: 'text', text: content }] };
    }
  },
  {
    name: 'http_request',
    groups: ['network'],
    executor: { type: 'network' },
    execute: async (args) => {
      // HTTPè¯·æ±‚é€»è¾‘
      return { content: [{ type: 'text', text: 'å“åº”' }] };
    }
  },
  {
    name: 'exec_command',
    groups: ['admin-only'],
    executor: { type: 'system' },
    execute: async (args) => {
      // ç³»ç»Ÿå‘½ä»¤é€»è¾‘
      return { content: [{ type: 'text', text: 'æ‰§è¡Œç»“æœ' }] };
    }
  }
];

// æ‰¹é‡æ‰§è¡Œ
const executor = new UnifiedExecutorLayer('./data');
for (const tool of tools) {
  try {
    const result = await executor.executeTool(tool, {}, 'user_token');
    console.log(`${tool.name}:`, result);
  } catch (error) {
    console.error(`${tool.name} æ‰§è¡Œå¤±è´¥:`, error.message);
  }
}
```

### ç¤ºä¾‹3: è§„åˆ™åŠ¨æ€ç®¡ç†

```typescript
// åŠ¨æ€è°ƒæ•´è§„åˆ™
async function adjustRules(token: string) {
  // æŸ¥çœ‹å½“å‰è§„åˆ™
  const currentRules = await ruleManagementTools[1].execute({ token });
  console.log('å½“å‰è§„åˆ™:', currentRules.structuredContent);

  // æ ¹æ®ä½¿ç”¨æƒ…å†µè°ƒæ•´
  const stats = await ruleManagementTools[4].execute({ executorId: 'filesystem' });
  
  // å¦‚æœè°ƒç”¨æ¬¡æ•°æ¥è¿‘ä¸Šé™ï¼Œå¢åŠ é™åˆ¶
  if (stats.usageCount > 80) {
    await ruleManagementTools[0].execute({
      token,
      executorId: 'filesystem',
      rules: { ...currentRules.structuredContent, maxCalls: 200 }
    });
    console.log('è§„åˆ™å·²æ›´æ–°');
  }
}
```

## ğŸ› ï¸ è‡ªå®šä¹‰æ‰§è¡Œå™¨

### 1. å®ç°è‡ªå®šä¹‰æ‰§è¡Œå™¨å·¥å‚

```typescript
// src/executors/custom/factory.ts
import { IExecutorFactory, ExecutorInstance, Tool } from '../../types';

export class CustomExecutorFactory implements IExecutorFactory {
  constructor(private ruleManager: any) {}

  async create(tool: Tool, token: string): Promise<ExecutorInstance> {
    // è·å–è§„åˆ™
    const rules = await this.ruleManager.getRules(token, 'custom');
    
    // åˆ›å»ºæ‰§è¡Œå™¨å®ä¾‹
    return new CustomExecutorInstance(tool, rules || {});
  }
}
```

### 2. å®ç°æ‰§è¡Œå™¨å®ä¾‹

```typescript
// src/executors/custom/instance.ts
import { ExecutorInstance, ToolResult } from '../../types';

export class CustomExecutorInstance implements ExecutorInstance {
  constructor(
    private tool: Tool,
    private rules: any
  ) {}

  async execute(args: any): Promise<ToolResult> {
    // 1. æ£€æŸ¥è‡ªåŠ¨æ‰¹å‡†
    if (!this.rules.autoApprove) {
      throw new Error('éœ€è¦å®¡æ‰¹');
    }

    // 2. æ£€æŸ¥è°ƒç”¨æ¬¡æ•°
    if (this.rules.maxCalls && this.callCount >= this.rules.maxCalls) {
      throw new Error('å·²è¾¾åˆ°æœ€å¤§è°ƒç”¨æ¬¡æ•°');
    }

    // 3. è‡ªå®šä¹‰éªŒè¯é€»è¾‘
    await this.validate(args);

    // 4. æ‰§è¡Œå·¥å…·
    const result = await this.tool.execute(args);

    // 5. æ›´æ–°è®¡æ•°
    this.callCount++;

    return result;
  }

  private async validate(args: any): Promise<void> {
    // è‡ªå®šä¹‰éªŒè¯é€»è¾‘
    if (this.rules.customValidation) {
      // æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯
    }
  }

  private callCount: number = 0;
}
```

### 3. æ³¨å†Œè‡ªå®šä¹‰æ‰§è¡Œå™¨

```typescript
// src/index.ts
import { CustomExecutorFactory } from './executors/custom/factory.js';

// æ³¨å†Œæ‰§è¡Œå™¨
executorFactory.register('custom', new CustomExecutorFactory(ruleManager));

// ä½¿ç”¨è‡ªå®šä¹‰æ‰§è¡Œå™¨
const customTool: Tool = {
  name: 'custom_tool',
  description: 'è‡ªå®šä¹‰å·¥å…·',
  groups: ['advanced'],
  executor: { type: 'custom' },
  inputSchema: {
    type: 'object',
    properties: { data: { type: 'string' } }
  },
  execute: async (args) => ({
    content: [{ type: 'text', text: `è‡ªå®šä¹‰å¤„ç†: ${args.data}` }]
  })
};
```

## ğŸ§ª æ‰§è¡Œå™¨æµ‹è¯•

### 1. æµ‹è¯•ä¸åŒæ‰§è¡Œå™¨

```typescript
// test/executors.test.js
import { UnifiedExecutorLayer } from '../build/core/unified-executor-layer.js';
import { ruleManagementTools } from '../build/index.js';

async function testExecutors() {
  const executor = new UnifiedExecutorLayer('./data');
  const token = 'test_token';

  // æµ‹è¯•DefaultExecutor
  const echoTool = {
    name: 'echo',
    groups: ['public'],
    execute: async (args) => ({ content: [{ type: 'text', text: args.message }] })
  };

  const result1 = await executor.executeTool(echoTool, { message: 'Hello' }, token);
  console.log('DefaultExecutor:', result1);

  // æµ‹è¯•FileSystemExecutor
  const fileTool = {
    name: 'file_read',
    groups: ['file-io'],
    executor: { type: 'filesystem' },
    execute: async (args) => {
      const fs = await import('fs/promises');
      const content = await fs.readFile(args.path, 'utf-8');
      return { content: [{ type: 'text', text: content }] };
    }
  };

  // è®¾ç½®è§„åˆ™
  await ruleManagementTools[0].execute({
    token,
    executorId: 'filesystem',
    rules: { autoApprove: true, maxFileSize: 1024 * 1024 }
  });

  const result2 = await executor.executeTool(fileTool, { path: '/tmp/test.txt' }, token);
  console.log('FileSystemExecutor:', result2);
}

testExecutors();
```

### 2. é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•æ‰§è¡Œå™¨æ¡†æ¶
# 1. ç¼–è¯‘é¡¹ç›®
npm run build

# 2. è¿è¡Œæµ‹è¯•
npx ts-node test-executor-system.ts

# 3. æµ‹è¯•Tokenä¸æ‰§è¡Œå™¨é›†æˆ
npx ts-node test-token-executor-integration.ts

# 4. æµ‹è¯•ç”¨æˆ·ç©ºé—´æ¶æ„
npx ts-node test-user-space-architecture.ts
```

## ğŸ¯ æ‰§è¡Œå™¨æ¡†æ¶ä¼˜åŠ¿

### 1. ç»Ÿä¸€æ¥å£
- æ‰€æœ‰å·¥å…·é€šè¿‡ç›¸åŒæ¥å£æ‰§è¡Œ
- ç®€åŒ–è°ƒç”¨é€»è¾‘
- æ˜“äºæ‰©å±•

### 2. çµæ´»çš„è§„åˆ™ç®¡ç†
- Tokençº§åˆ«è§„åˆ™
- é»˜è®¤è§„åˆ™æ”¯æŒ
- åŠ¨æ€è°ƒæ•´

### 3. å®‰å…¨æ§åˆ¶
- è‡ªåŠ¨æ‰¹å‡†æœºåˆ¶
- è°ƒç”¨æ¬¡æ•°é™åˆ¶
- èµ„æºé™åˆ¶

### 4. ç±»å‹å®‰å…¨
- æ˜ç¡®çš„æ‰§è¡Œå™¨ç±»å‹
- è‡ªåŠ¨æ¨æ–­æœºåˆ¶
- æ˜¾å¼å£°æ˜æ”¯æŒ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œå™¨é€‰æ‹©**: å·¥å…·è‡ªå£°æ˜ > è‡ªåŠ¨æ¨æ–­ > é»˜è®¤æ‰§è¡Œå™¨
2. **è§„åˆ™ä¼˜å…ˆçº§**: Tokenç‰¹å®šè§„åˆ™ > é»˜è®¤è§„åˆ™
3. **æ€§èƒ½è€ƒè™‘**: æ–‡ä»¶å­˜å‚¨é€‚åˆä¸­å°è§„æ¨¡
4. **å®‰å…¨è€ƒè™‘**: ç³»ç»Ÿæ‰§è¡Œå™¨é»˜è®¤éœ€è¦å®¡æ‰¹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å·¥å…·å¼€å‘**ï¼š[01_å·¥å…·å¼€å‘åŸºç¡€.md](01_å·¥å…·å¼€å‘åŸºç¡€.md)
- **æƒé™æ§åˆ¶**ï¼š[02_æƒé™æ§åˆ¶è¯¦è§£.md](02_æƒé™æ§åˆ¶è¯¦è§£.md)
- **Tokenç®¡ç†**ï¼š[05_Tokenç®¡ç†ç³»ç»Ÿ.md](05_Tokenç®¡ç†ç³»ç»Ÿ.md)
- **ç”¨æˆ·ç©ºé—´æ¶æ„**ï¼š[08_ç”¨æˆ·ç©ºé—´æ¶æ„è¯´æ˜.md](08_ç”¨æˆ·ç©ºé—´æ¶æ„è¯´æ˜.md)

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [08_ç”¨æˆ·ç©ºé—´æ¶æ„è¯´æ˜.md](08_ç”¨æˆ·ç©ºé—´æ¶æ„è¯´æ˜.md)